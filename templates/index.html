<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novel Proofer - 小说打样员</title>
  <link rel="icon" type="image/svg+xml" href="images/logo.svg" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
            serif: ['"Noto Serif SC"', 'serif'],
            mono: ['"JetBrains Mono"', '"SF Mono"', 'Consolas', 'monospace'],
          },
          colors: {
            paper: '#FDFBF7',
            ink: '#18181b', // zinc-950
          }
        }
      }
    }
  </script>

  <style>
    /* Custom scrollbar for webkit */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #d4d4d8; }
    
    .tab-btn.active { color: #18181b; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #18181b; }
    
    .filter-btn.active { background-color: #18181b; color: white; border-color: #18181b; }
    
    /* Smooth fade for content */
    .tab-content { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0.95; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

    /* Hide checkbox default and use custom if needed, but standard accent-color is fine for MVP */
    input[type="checkbox"] { accent-color: #18181b; width: 1rem; height: 1rem; cursor: pointer; }
  </style>
</head>
<body class="bg-paper text-slate-800 font-sans antialiased min-h-screen selection:bg-zinc-200 selection:text-ink pb-12">

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-paper mb-5">
        <img src="images/logo.svg" alt="Logo" class="w-12 h-12 opacity-90" />
      </div>
      <h1 class="font-serif text-3xl font-bold tracking-tight text-ink mb-2">Novel Proofer</h1>
      <p class="text-slate-500 font-serif tracking-wide text-sm">优雅的中文小说排版校对工具</p>
    </header>

    <!-- Main Card -->
    <main class="bg-white rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-slate-100 overflow-hidden">
      
      <div class="p-6 sm:p-8">
        <form id="mainForm" action="#" method="post" enctype="multipart/form-data">
          
          <!-- File Upload Section -->
          <div class="mb-8">
            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">源文件</label>
            <div class="file-drop group relative w-full p-8 border-2 border-dashed border-slate-200 rounded-xl hover:border-ink/50 hover:bg-slate-50 transition-all duration-200 cursor-pointer text-center" id="fileDrop">
              <div class="pointer-events-none">
                <div class="mb-3 text-slate-400 group-hover:text-ink transition-colors">
                  <svg class="w-8 h-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div class="text-sm font-medium text-slate-600 group-hover:text-ink transition-colors">点击选择或拖拽 TXT 文件</div>
                <div class="mt-2 text-xs text-slate-400 font-mono" id="fileName">未选择任何文件</div>
              </div>
              <input name="file" type="file" accept=".txt,text/plain" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap items-center gap-3 mb-8">
            <button type="button" id="btnStart" class="px-6 py-2.5 bg-ink hover:bg-zinc-800 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]">
              开始校对
            </button>
            <button type="button" id="btnPause" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              暂停
            </button>
            <button type="button" id="btnCancel" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              取消
            </button>
            <button type="button" id="btnRetry" class="px-5 py-2.5 bg-white border border-amber-200 text-amber-700 hover:bg-amber-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              重试失败部分
            </button>
            <button type="button" id="btnRerunAll" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              重跑全部
            </button>
            <button type="button" id="btnCleanup" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              清理文件
            </button>
          </div>

          <!-- Progress Bar -->
          <div class="mb-8 hidden" id="progress">
            <div class="flex justify-between text-xs font-medium text-slate-500 mb-2" id="meta">
              <span id="metaLeft">准备中</span>
              <span id="metaRight">0%</span>
            </div>
            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              <div class="h-full bg-ink transition-all duration-300 ease-out" style="width: 0%" id="bar"></div>
            </div>
          </div>

          <!-- Output Message Area -->
          <div class="mb-8 hidden" id="out">
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
              <pre id="outText" class="text-xs font-mono text-slate-600 whitespace-pre-wrap break-all"></pre>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="flex gap-6 border-b border-slate-100 mb-6">
            <button type="button" class="tab-btn active pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative" data-tab="progress">参数设置</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative" data-tab="debug">分析进度</button>
          </div>

          <!-- Tab: Settings -->
          <div id="tab-progress" class="tab-content block">
            
            <div class="grid gap-8">
              <!-- Formatting Section -->
              <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">格式化选项</label>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="paragraph_indent" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">段首统一缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="indent_with_fullwidth_space" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">全角空格缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_blank_lines" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">过多空行压缩</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="trim_trailing_spaces" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">去除行尾空格</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_ellipsis" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范省略号 ……</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_em_dash" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范破折号 ——</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_cjk_punctuation" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">中英标点统一</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="fix_cjk_punct_spacing" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">修正标点间距</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_quotes" value="1" class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">引号统一（慎用）</span>
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                   <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出后缀</label>
                    <input name="suffix" type="text" value="_rev" placeholder="_rev" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">分片大小 (200-4000)</label>
                    <input name="max_chunk_chars" type="number" min="200" max="4000" step="100" value="2000" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出预览</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono text-slate-400 truncate select-all" id="outputPreview">output/&lt;job_id&gt;_input_rev.txt</div>
                  </div>
                </div>
              </div>

              <!-- LLM Section -->
              <div class="pt-6 border-t border-slate-100">
                <div class="flex items-center justify-between mb-4">
                  <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">LLM 配置 (辅助精修)</label>
                  <div class="flex items-center gap-2">
                    <button type="button" class="text-xs text-ink hover:underline font-medium" id="btnSaveLlmDefaults">保存为默认</button>
                    <span id="llmDirtyHint" class="text-[10px] text-amber-500 font-bold hidden">● 未保存</span>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Base URL</label>
                    <input name="llm_base_url" type="text" placeholder="https://api.openai.com/v1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Model Name</label>
                    <input name="llm_model" type="text" placeholder="DeepSeek-V3" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">API Key</label>
                    <div class="relative">
                      <input name="llm_api_key" type="password" placeholder="sk-..." class="w-full pl-3 pr-12 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                      <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 hover:text-ink px-1.5 py-0.5" id="btnToggleApiKey">SHOW</button>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Temp</label>
                    <input name="llm_temperature" type="number" step="0.1" value="0" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Timeout (s)</label>
                    <input name="llm_timeout_seconds" type="number" step="1" value="180" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Concurrency</label>
                    <input name="llm_max_concurrency" type="number" min="1" step="1" value="20" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                </div>

                <div>
                   <label class="block text-xs font-medium text-slate-500 mb-1.5">额外参数 (JSON)</label>
                   <textarea name="llm_extra_params" placeholder='{"max_tokens": 4096}' class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono h-20 resize-y focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow"></textarea>
                </div>
              </div>

              <!-- Footer Debug Option -->
              <div class="pt-4 border-t border-slate-100 flex items-center justify-between">
                 <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="cleanup_debug_dir" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-xs text-slate-500">完成后自动删除调试中间文件</span>
                    <input type="hidden" name="cleanup_debug_dir" value="0">
                 </label>
                 <div class="text-[10px] text-slate-300">v1.0</div>
              </div>

            </div>
          </div>
          <!-- End Settings Tab -->

          <!-- Tab: Debug -->
          <div id="tab-debug" class="tab-content hidden">
            
            <!-- Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-6 gap-4 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100" id="statsBar">
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Total</div>
                <div class="font-mono font-bold text-lg text-slate-700" id="statTotal">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Done</div>
                <div class="font-mono font-bold text-lg text-green-600" id="statDone">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Processing</div>
                <div class="font-mono font-bold text-lg text-blue-600" id="statProcessing">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Pending</div>
                <div class="font-mono font-bold text-lg text-slate-500" id="statPending">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Retry</div>
                <div class="font-mono font-bold text-lg text-amber-500" id="statRetrying">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-slate-400 mb-1">Error</div>
                <div class="font-mono font-bold text-lg text-red-500" id="statError">0</div>
              </div>
            </div>

            <!-- Filter -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
               <button type="button" class="filter-btn active px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="all">全部</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="error">错误</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="retrying">重试中</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="processing">处理中</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="pending">待处理</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="done">完成</button>
            </div>

            <!-- Table -->
            <div class="border border-slate-200 rounded-lg overflow-hidden" id="chunksTableWrap">
               <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left text-xs">
                  <thead class="bg-slate-50 text-slate-500 font-medium sticky top-0 z-10 shadow-sm">
                    <tr>
                      <th class="p-3 w-16">#</th>
                      <th class="p-3 w-32">状态</th>
                      <th class="p-3 w-16">重试</th>
                      <th class="p-3 w-24">I/O</th>
                      <th class="p-3">信息</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white" id="chunksBody">
                    <!-- JS rendered -->
                  </tbody>
                </table>
               </div>
            </div>
            
            <div id="noChunksHint" class="text-center py-12 text-slate-400 text-sm hidden">
              暂无分片数据，请先开始校对任务。
            </div>

          </div>
          <!-- End Debug Tab -->

        </form>
      </div>
    </main>

    <div class="mt-8 text-center">
       <div class="inline-block px-4 py-2 rounded-full bg-white border border-slate-100 shadow-sm text-xs text-slate-400">
         Powered by LLM & Heuristic Rules
       </div>
    </div>
    
  </div>

  <script>
    // DOM Elements
    const form = document.getElementById('mainForm');
    const out = document.getElementById('out');
    const outText = document.getElementById('outText');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const meta = document.getElementById('meta');
    const metaLeft = document.getElementById('metaLeft');
    const metaRight = document.getElementById('metaRight');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnCancel = document.getElementById('btnCancel');
    const btnRetry = document.getElementById('btnRetry');
    const btnRerunAll = document.getElementById('btnRerunAll');
    const btnCleanup = document.getElementById('btnCleanup');
    const btnSaveLlmDefaults = document.getElementById('btnSaveLlmDefaults');
    const llmDirtyHint = document.getElementById('llmDirtyHint');
    const btnToggleApiKey = document.getElementById('btnToggleApiKey');
    const fileInput = form.querySelector('input[name="file"]');
    const suffixInput = form.querySelector('input[name="suffix"]');
    const outputPreview = document.getElementById('outputPreview');
    const fileDrop = document.getElementById('fileDrop');
    const fileName = document.getElementById('fileName');

    // Debug tab elements
    const chunksBody = document.getElementById('chunksBody');
    const noChunksHint = document.getElementById('noChunksHint');
    const chunksTableWrap = document.getElementById('chunksTableWrap');
    const statTotal = document.getElementById('statTotal');
    const statDone = document.getElementById('statDone');
    const statProcessing = document.getElementById('statProcessing');
    const statPending = document.getElementById('statPending');
    const statError = document.getElementById('statError');
    const statRetrying = document.getElementById('statRetrying');

    let currentJobId = null;
    let currentJobState = null;
    let currentFilter = 'all';
    let activeTab = 'progress';
    let forceChunksFetch = false;
    let chunksData = [];
    let chunkCounts = null;
    let totalChunksFromServer = 0;
    let chunksFetchInFlight = false;

    const UI_STATE_KEY = 'novel_proofer.ui_state.v1';
    const UI_STATE_FIELDS = [
      'suffix',
      'max_chunk_chars',
      'paragraph_indent',
      'indent_with_fullwidth_space',
      'normalize_blank_lines',
      'trim_trailing_spaces',
      'normalize_ellipsis',
      'normalize_em_dash',
      'normalize_cjk_punctuation',
      'fix_cjk_punct_spacing',
      'normalize_quotes',
      'cleanup_debug_dir',
    ];

    function _uiStateElement(name) {
      if (name === 'cleanup_debug_dir') {
        return form.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]');
      }
      return form.querySelector(`[name="${name}"]`);
    }

    function loadUiState() {
      try {
        const raw = localStorage.getItem(UI_STATE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        if (!state || typeof state !== 'object') return;
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          if (el.type === 'checkbox') {
            el.checked = !!state[name];
          } else if (state[name] != null) {
            el.value = String(state[name]);
          }
        }
      } catch (e) {}
    }

    function saveUiState() {
      try {
        const state = {};
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          state[name] = (el.type === 'checkbox') ? !!el.checked : String(el.value || '');
        }
        localStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
      } catch (e) {}
    }

    function _previewOutputPath() {
      const file = fileInput?.files?.[0];
      const rawName = String(file?.name || 'input.txt');
      const name = rawName.split(/[\\/]/).pop() || 'input.txt';
      const dot = name.lastIndexOf('.');
      const stem = (dot > 0) ? name.slice(0, dot) : name;
      const ext = (dot > 0) ? name.slice(dot) : '.txt';
      const suffix = String(suffixInput?.value || '_rev').trim() || '_rev';
      return `output/<job_id>_${stem}${suffix}${ext}`;
    }

    function refreshOutputPreview() {
      if (!outputPreview) return;
      outputPreview.textContent = _previewOutputPath();
    }

    function refreshFileName() {
      const file = fileInput?.files?.[0];
      if (fileName) fileName.textContent = file ? file.name : '未选择任何文件';
      refreshOutputPreview();
    }

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
      activeTab = tabName;
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-600', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-400', btn.dataset.tab !== tabName);
      });
      tabContents.forEach(content => {
          if (content.id === 'tab-' + tabName) {
              content.classList.remove('hidden');
              content.classList.add('block');
          } else {
              content.classList.add('hidden');
              content.classList.remove('block');
          }
      });
      
      localStorage.setItem('activeTab', tabName);
      if (tabName === 'debug' && currentJobId) {
        forceChunksFetch = true;
        refreshChunksNow(currentJobId);
      }
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Restore tab from localStorage
    const savedTab = localStorage.getItem('activeTab');
    switchTab(savedTab || 'progress');

    loadUiState();
    refreshFileName();
    UI_STATE_FIELDS.forEach((name) => {
      const el = _uiStateElement(name);
      if (!el) return;
      el.addEventListener('input', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
      el.addEventListener('change', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
    });
    fileInput?.addEventListener('change', refreshFileName);
    if (fileInput && fileDrop) {
      const addDrag = () => {
          fileDrop.classList.add('border-ink', 'bg-slate-50');
      };
      const rmDrag = () => {
          fileDrop.classList.remove('border-ink', 'bg-slate-50');
      };
      fileInput.addEventListener('dragenter', addDrag);
      fileInput.addEventListener('dragleave', rmDrag);
      fileInput.addEventListener('drop', () => {
        rmDrag();
        // Let the browser populate input.files, then refresh UI.
        setTimeout(refreshFileName, 0);
      });
    }

    // Filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        filterBtns.forEach(b => b.classList.toggle('active', b === btn));
        if (activeTab === 'debug' && currentJobId) {
          forceChunksFetch = true;
          refreshChunksNow(currentJobId);
        } else {
          renderChunksTable();
        }
      });
    });

    function getStatusBadge(state) {
      const config = {
          pending: { class: 'bg-slate-100 text-slate-500', label: '待处理' },
          processing: { class: 'bg-blue-50 text-blue-600', label: '处理中' },
          done: { class: 'bg-green-50 text-green-600', label: '完成' },
          error: { class: 'bg-red-50 text-red-600', label: '错误' },
          retrying: { class: 'bg-amber-50 text-amber-600', label: '重试中' }
      };
      
      const c = config[state] || config.pending;
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${c.class}">${c.label}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncateStr(s, maxLen) {
      const str = String(s || '');
      const n = Number(maxLen || 0);
      if (!Number.isFinite(n) || n <= 0) return str;
      if (str.length <= n) return str;
      return str.slice(0, n) + '…';
    }

    function tryParseJson(s) {
      try {
        return JSON.parse(s);
      } catch (e) {
        return null;
      }
    }

    function formatErrorDisplay(code, message) {
      const codeStr = (code == null || code === '') ? '' : String(code);
      const msg = (message == null) ? '' : String(message).trim();

      if (!codeStr && !msg) return null;

      const httpMatch = msg.match(/^HTTP\s+(\d+)\s+from\s+LLM:\s*(.*)$/i);
      if (httpMatch) {
        const httpCode = httpMatch[1] || codeStr || '';
        const body = String(httpMatch[2] || '').trim();

        let reason = '';
        if (body) {
          const parsed = (body.startsWith('{') || body.startsWith('[')) ? tryParseJson(body) : null;
          if (parsed && parsed.error && parsed.error.message) reason = String(parsed.error.message);
          else if (parsed && parsed.message) reason = String(parsed.message);
          else reason = body;
        }

        const brief = httpCode ? `HTTP ${httpCode}` : 'HTTP error';
        const detail = reason ? `${brief}: ${reason}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      if (/LLM output empty/i.test(msg)) {
        return { brief: 'LLM output empty', detail: 'LLM output empty' };
      }

      if (/LLM output too short/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too short (ratio=${m[1]})` : 'LLM output too short';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (/LLM output too long/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too long (ratio=${m[1]})` : 'LLM output too long';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (codeStr) {
        const brief = `HTTP ${codeStr}`;
        const detail = msg ? `${brief}: ${msg}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      const brief = truncateStr(msg, 60);
      return { brief, detail: truncateStr(msg, 300) };
    }

    function renderChunksTable() {
      if (!chunksData || chunksData.length === 0) {
        noChunksHint.classList.remove('hidden');
        chunksTableWrap.classList.add('hidden');
        if (currentJobId) {
          if (currentFilter === 'all') {
            noChunksHint.textContent = '暂无分片数据（可切换到调试信息页以加载）。';
          } else {
            noChunksHint.textContent = '当前过滤条件下无匹配分片。';
          }
        } else {
          noChunksHint.textContent = '暂无分片数据，请先开始校对任务。';
        }
        return;
      }

      noChunksHint.classList.add('hidden');
      chunksTableWrap.classList.remove('hidden');

       const rows = chunksData.slice(0, 500).map(c => {
         let inOut = '-';
         if (c.input_chars != null && c.output_chars != null) inOut = `${c.input_chars}/${c.output_chars}`;
         else if (c.input_chars != null) inOut = `${c.input_chars}/-`;

         const errCode = (c.last_error_code != null) ? String(c.last_error_code) : '';
         const errFull = c.last_error_message ? String(c.last_error_message) : '';
         const err = formatErrorDisplay(errCode, errFull);
         const errMsg = err
           ? `<span class="text-red-500 cursor-help border-b border-dotted border-red-300" title="${escapeHtml(err.detail)}">${escapeHtml(err.brief)}</span>`
           : '-';

         return `<tr class="hover:bg-slate-50 transition-colors">
           <td class="p-3 text-slate-400 font-mono">${c.index}</td>
           <td class="p-3">${getStatusBadge(c.state)}</td>
           <td class="p-3 text-slate-500">${c.retries}</td>
           <td class="p-3 text-slate-500 font-mono text-[11px]">${inOut}</td>
           <td class="p-3 text-slate-600">${errMsg}</td>
         </tr>`;
       }).join('');


      chunksBody.innerHTML = rows;
    }

    function updateStats() {
      const counts = chunkCounts || {};
      statTotal.textContent = String(totalChunksFromServer || 0);
      statDone.textContent = String(counts.done || 0);
      statProcessing.textContent = String(counts.processing || 0);
      statPending.textContent = String(counts.pending || 0);
      statRetrying.textContent = String(counts.retrying || 0);
      statError.textContent = String(counts.error || 0);
    }

    function showChunks(data) {
      if (!data || !Array.isArray(data.chunks)) return;

      chunksData = data.chunks;
      chunkCounts = data.chunk_counts || null;
      totalChunksFromServer = Number(data?.job?.progress?.total_chunks || 0);
      updateStats();
      renderChunksTable();
    }

    async function refreshChunksNow(jobId) {
      if (!jobId) return;
      if (chunksFetchInFlight) return;
      chunksFetchInFlight = true;
      try {
        const q = new URLSearchParams({ chunks: '1' });
        q.set('chunk_state', currentFilter);
        q.set('limit', '500');
        q.set('offset', '0');

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        showChunks(data);
      } catch (e) {
        show(String(e));
      } finally {
        chunksFetchInFlight = false;
      }
    }

    function show(obj) {
      out.classList.remove('hidden');
      outText.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    function setProgress(done, total, state) {
      progress.classList.remove('hidden');
      // meta.style.display = 'flex'; // handled by class
      const pct = total > 0 ? Math.floor((done / total) * 100) : (state === 'done' ? 100 : 0);
      bar.style.width = pct + '%';
      metaLeft.textContent = `${state}  ${done}/${total}`;
      metaRight.textContent = pct + '%';
      
      const stateLabels = {
        queued: '已提交，准备开始…',
        running: '正在处理中…',
        paused: '已暂停',
        done: '处理完成',
        cancelled: '已取消',
        error: '处理出错'
      };
      if (stateLabels[state]) {
        out.classList.remove('hidden');
        outText.textContent = stateLabels[state];
      }
    }

    function setBusy(busy) {
      btnStart.disabled = busy;
      btnStart.classList.toggle('opacity-50', busy);
      btnStart.classList.toggle('cursor-not-allowed', busy);
      
      const toggleBtn = (btn, show) => {
          if (show) {
              btn.classList.remove('hidden', 'inline-block'); // reset
              btn.classList.add('inline-block'); // add display
          } else {
              btn.classList.add('hidden');
              btn.classList.remove('inline-block');
          }
      }

      toggleBtn(btnPause, busy);
      btnPause.disabled = !busy;
      btnPause.textContent = '暂停';
      
      toggleBtn(btnCancel, busy);
      btnCancel.disabled = !busy;

      if (busy) {
        toggleBtn(btnRetry, false);
        btnRetry.disabled = true;
        toggleBtn(btnRerunAll, false);
        btnRerunAll.disabled = true;
        toggleBtn(btnCleanup, false);
        btnCleanup.disabled = true;
      }
    }

    function setPaused(paused) {
      btnStart.disabled = paused;
      btnStart.classList.toggle('opacity-50', paused);
      btnStart.classList.toggle('cursor-not-allowed', paused);

      const toggleBtn = (btn, show) => {
          if (show) {
              btn.classList.remove('hidden');
              btn.classList.add('inline-block');
          } else {
              btn.classList.add('hidden');
          }
      }

      toggleBtn(btnPause, paused);
      btnPause.disabled = !paused;
      btnPause.textContent = '继续';
      
      toggleBtn(btnCancel, paused);
      btnCancel.disabled = !paused;
      
      toggleBtn(btnRetry, false);
      btnRetry.disabled = true;
      toggleBtn(btnRerunAll, false);
      btnRerunAll.disabled = true;
      toggleBtn(btnCleanup, false);
      btnCleanup.disabled = true;
    }

    function setRetryVisible(visible) {
      const toggleBtn = (btn, show) => {
          if (show) {
              btn.classList.remove('hidden');
              btn.classList.add('inline-block');
          } else {
              btn.classList.add('hidden');
          }
      }
      toggleBtn(btnRetry, visible);
      btnRetry.disabled = !visible;
    }

    function setRerunAllVisible(visible) {
      const toggleBtn = (btn, show) => {
          if (show) {
              btn.classList.remove('hidden');
              btn.classList.add('inline-block');
          } else {
              btn.classList.add('hidden');
          }
      }
      toggleBtn(btnRerunAll, visible);
      btnRerunAll.disabled = !visible;
    }

    function setCleanupVisible(visible) {
        const toggleBtn = (btn, show) => {
          if (show) {
              btn.classList.remove('hidden');
              btn.classList.add('inline-block');
          } else {
              btn.classList.add('hidden');
          }
      }
      toggleBtn(btnCleanup, visible);
      btnCleanup.disabled = !visible;
    }

    function _llmSnapshot() {
      const fd = new FormData(form);
      return JSON.stringify({
        base_url: String(fd.get('llm_base_url') || ''),
        model: String(fd.get('llm_model') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        temperature: String(fd.get('llm_temperature') || ''),
        timeout_seconds: String(fd.get('llm_timeout_seconds') || ''),
        max_concurrency: String(fd.get('llm_max_concurrency') || ''),
        extra_params: String(fd.get('llm_extra_params') || '').trim(),
      });
    }

    let _llmSavedSnapshot = null;

    function _setLlmDirty(dirty) {
      llmDirtyHint.classList.toggle('hidden', !dirty);
      llmDirtyHint.classList.toggle('inline', dirty);
      btnSaveLlmDefaults.disabled = !dirty;
      btnSaveLlmDefaults.classList.toggle('opacity-50', !dirty);
    }

    function _refreshLlmDirty() {
      if (_llmSavedSnapshot == null) return;
      _setLlmDirty(_llmSnapshot() !== _llmSavedSnapshot);
    }

    async function loadLlmDefaults() {
      try {
        const res = await fetch('api/v1/settings/llm');
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        const llm = data?.llm || {};
        const setIfProvided = (name, value) => {
          if (value === undefined || value === null) return;
          const el = form.querySelector(`[name="${name}"]`);
          if (!el) return;
          el.value = String(value);
        };

        setIfProvided('llm_base_url', llm.base_url);
        setIfProvided('llm_model', llm.model);
        setIfProvided('llm_api_key', llm.api_key);
        if (llm.temperature !== undefined && llm.temperature !== null) setIfProvided('llm_temperature', llm.temperature);
        if (llm.timeout_seconds !== undefined && llm.timeout_seconds !== null) setIfProvided('llm_timeout_seconds', llm.timeout_seconds);
        if (llm.max_concurrency !== undefined && llm.max_concurrency !== null) setIfProvided('llm_max_concurrency', llm.max_concurrency);
        if (llm.extra_params !== undefined && llm.extra_params !== null) {
          const el = form.querySelector('[name="llm_extra_params"]');
          if (el) el.value = JSON.stringify(llm.extra_params, null, 2);
        }
      } catch (e) {
        show(String(e));
      } finally {
        _llmSavedSnapshot = _llmSnapshot();
        _setLlmDirty(false);
      }
    }

    async function requestSaveLlmDefaults() {
      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = {
        llm: {
          base_url: String(fd.get('llm_base_url') || ''),
          api_key: String(fd.get('llm_api_key') || ''),
          model: String(fd.get('llm_model') || ''),
          temperature: Number(fd.get('llm_temperature') || 0),
          timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
          max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
          extra_params: extra.value,
        }
      };
      try {
        const res = await fetch('api/v1/settings/llm', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnSaveLlmDefaults.addEventListener('click', async () => {
      btnSaveLlmDefaults.disabled = true;
      const r = await requestSaveLlmDefaults();
      if (!r.ok) {
        show(r.error);
        _refreshLlmDirty();
        return;
      }
      show('默认 LLM 配置已保存。');
      _llmSavedSnapshot = _llmSnapshot();
      _setLlmDirty(false);
    });

    ['llm_base_url', 'llm_model', 'llm_api_key', 'llm_temperature', 'llm_timeout_seconds', 'llm_max_concurrency', 'llm_extra_params'].forEach((name) => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;
      el.addEventListener('input', _refreshLlmDirty);
      el.addEventListener('change', _refreshLlmDirty);
    });

    btnToggleApiKey.addEventListener('click', () => {
      const el = form.querySelector('[name="llm_api_key"]');
      if (!el) return;
      if (el.type === 'password') {
        el.type = 'text';
        btnToggleApiKey.textContent = 'HIDE';
      } else {
        el.type = 'password';
        btnToggleApiKey.textContent = 'SHOW';
      }
    });

    function parseExtraParamsFromFormData(fd) {
      const raw = String(fd.get('llm_extra_params') || '').trim();
      if (!raw) return { ok: true, value: null };
      try {
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) {
          return { ok: false, error: '额外参数必须是 JSON 对象（例如 {"max_tokens": 4096}）。' };
        }
        return { ok: true, value: obj };
      } catch (e) {
        return { ok: false, error: '额外参数 JSON 无效，请检查括号/引号/逗号。' };
      }
    }

    function buildLlmOptions(fd, extraParamsValue) {
      return {
        base_url: String(fd.get('llm_base_url') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        model: String(fd.get('llm_model') || ''),
        temperature: Number(fd.get('llm_temperature') || 0),
        timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
        max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
        extra_params: extraParamsValue,
      };

    }

    function buildJobOptions(fd, extraParamsValue) {
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      return {
        format: {
          max_chunk_chars: Number(fd.get('max_chunk_chars') || 2000),
          paragraph_indent: fd.get('paragraph_indent') != null,
          indent_with_fullwidth_space: fd.get('indent_with_fullwidth_space') != null,
          normalize_blank_lines: fd.get('normalize_blank_lines') != null,
          trim_trailing_spaces: fd.get('trim_trailing_spaces') != null,
          normalize_ellipsis: fd.get('normalize_ellipsis') != null,
          normalize_em_dash: fd.get('normalize_em_dash') != null,
          normalize_cjk_punctuation: fd.get('normalize_cjk_punctuation') != null,
          fix_cjk_punct_spacing: fd.get('fix_cjk_punct_spacing') != null,
          normalize_quotes: fd.get('normalize_quotes') != null,
        },
        llm: buildLlmOptions(fd, extraParamsValue),
        output: {
          suffix: String(fd.get('suffix') || '_rev'),
          cleanup_debug_dir: cleanupDebugDir,
        },
      };
    }

    async function requestCancel(jobId) {
      if (!jobId) return;
      try {
        await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cancel`, { method: 'POST' });
      } catch (e) {}
    }

    async function requestPause(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/pause`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestResume(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnPause.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;

      // Resume when paused; otherwise pause.
      if (currentJobState === 'paused') {
        show('继续分析…');
        setBusy(true);
        setRetryVisible(false);
        setCleanupVisible(false);
        const r = await requestResume(jobId);
        if (!r.ok) {
          show(r.error);
          setPaused(true);
          return;
        }
        currentJobState = 'running';
        await poll(jobId);
        return;
      }

      btnPause.disabled = true;
      show('正在暂停…');
      const r = await requestPause(jobId);
      if (!r.ok) {
        show(r.error);
        btnPause.disabled = false;
      }
    });

    btnCancel.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      currentJobId = null;
      currentJobState = null;
      setProgress(0, 0, 'cancelled');
      show('已取消。');
      setBusy(false);
      setRetryVisible(false);
      setCleanupVisible(false);
      await requestCancel(jobId);
    });

    async function requestRetryFailed(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/retry-failed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnRetry.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('准备重试失败分片…');
      setBusy(true);
      setRetryVisible(false);
      setRerunAllVisible(false);
      setCleanupVisible(false);
      const r = await requestRetryFailed(jobId);
      if (!r.ok) {
        show(r.error);
        setBusy(false);
        setRetryVisible(true);
        setRerunAllVisible(true);
        setCleanupVisible(true);
        return;
      }
      await poll(jobId);
    });

    async function requestRerunAll(jobId, options) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/rerun-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(options),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnRerunAll.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const ok = confirm('确认重跑全部分片（新任务）？该操作不会修改旧任务，但会创建一个新任务并从头开始处理。');
      if (!ok) return;

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) {
        show(extra.error);
        return;
      }

      show('正在创建新任务并重跑全部分片…');
      setBusy(true);
      setRetryVisible(false);
      setRerunAllVisible(false);
      setCleanupVisible(false);

      const opts = buildJobOptions(fd, extra.value);
      const r = await requestRerunAll(jobId, opts);
      if (!r.ok) {
        show(r.error);
        setBusy(false);
        setRetryVisible(true);
        setRerunAllVisible(true);
        setCleanupVisible(true);
        return;
      }

      currentJobId = r?.data?.job?.id;
      currentJobState = 'queued';
      chunksData = [];
      chunkCounts = null;
      totalChunksFromServer = 0;
      updateStats();
      renderChunksTable();
      await poll(currentJobId);
    });

    async function requestCleanup(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cleanup-debug`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnCleanup.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const ok = confirm('确认清理中间文件？清理后将无法继续重试失败部分或重跑全部。');
      if (!ok) return;

      btnCleanup.disabled = true;
      show('正在清理中间文件…');
      const r = await requestCleanup(jobId);
      if (!r.ok) {
        show(r.error);
        btnCleanup.disabled = false;
        return;
      }

      show('已清理中间文件。');
      setRetryVisible(false);
      setRerunAllVisible(false);
      setCleanupVisible(false);
      currentJobId = null;
      currentJobState = null;
      chunksData = [];
      updateStats();
      renderChunksTable();
    });

    async function poll(jobId) {
      while (true) {
        if (!currentJobId || currentJobId !== jobId) return;

        const wantChunks = (activeTab === 'debug') || forceChunksFetch;
        forceChunksFetch = false;

        const q = new URLSearchParams({ chunks: wantChunks ? '1' : '0' });
        if (wantChunks) {
          q.set('chunk_state', currentFilter);
          q.set('limit', '500');
          q.set('offset', '0');
        }

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data));

        currentJobState = data?.job?.state;
        setProgress(data?.job?.progress?.done_chunks || 0, data?.job?.progress?.total_chunks || 0, data?.job?.state);
        if (wantChunks) showChunks(data);

        if (data?.job?.state === 'done') {
          show(data?.job?.output_path ? `完成。已输出到：${data.job.output_path}` : '完成。已输出到项目 output/ 目录。');
          setBusy(false);
          currentJobId = null;
          currentJobState = null;
          setRetryVisible(false);
          setRerunAllVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'cancelled') {
          show('已取消。');
          setBusy(false);
          currentJobId = null;
          currentJobState = null;
          setRetryVisible(false);
          setRerunAllVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'paused') {
          show('已暂停。');
          setBusy(false);
          setPaused(true);
          setRetryVisible(false);
          setRerunAllVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'error') {
          show(data?.job?.error || data);
          setBusy(false);
          setRetryVisible(true);
          setRerunAllVisible(true);
          setCleanupVisible(true);
          return;
        }

        await new Promise(r => setTimeout(r, 800));
      }
    }

    // btnStart click triggers form submit (button is outside form)
    btnStart.addEventListener('click', () => {
      form.requestSubmit();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (currentJobId && (currentJobState === 'queued' || currentJobState === 'running' || currentJobState === 'paused')) return;
      currentJobId = null;
      currentJobState = null;
      setRetryVisible(false);
      setRerunAllVisible(false);
      setCleanupVisible(false);

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) {
        show(extra.error);
        return;
      }
      const maxChunkChars = Number(fd.get('max_chunk_chars') || 0);
      if (!Number.isFinite(maxChunkChars) || maxChunkChars < 200 || maxChunkChars > 4000) {
        show('分片大小（字符数）必须在 200-4000 之间。');
        return;
      }
      show('已提交，准备开始…');
      setProgress(0, 0, 'queued');
      setBusy(true);

      const file = fd.get('file');
      if (!(file instanceof File)) {
        show('请选择 TXT 文件。');
        setBusy(false);
        return;
      }
      const opts = buildJobOptions(fd, extra.value);
      const requestFd = new FormData();
      requestFd.append('file', file);
      requestFd.append('options', JSON.stringify(opts));

      const res = await fetch('api/v1/jobs', { method: 'POST', body: requestFd });
      const data = await res.json();
      if (!res.ok) {
        show(data);
        setBusy(false);
        return;
      }

      currentJobId = data?.job?.id;
      currentJobState = 'queued';
      await poll(currentJobId);
    });

    loadLlmDefaults();
  </script>
</body>
</html>
