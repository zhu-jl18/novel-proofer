<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novel Proofer - 小说打样员</title>
  <link rel="icon" type="image/svg+xml" href="images/logo.svg" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
            serif: ['"Noto Serif SC"', 'serif'],
            mono: ['"JetBrains Mono"', '"SF Mono"', 'Consolas', 'monospace'],
          },
          colors: {
            paper: '#FDFBF7',
            ink: '#18181b', // zinc-950
          }
        }
      }
    }
  </script>

  <style>
    /* Custom scrollbar for webkit */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #d4d4d8; }
    
    .tab-btn.active { color: #18181b; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #18181b; }
    
    .filter-btn.active { background-color: #18181b; color: white; border-color: #18181b; }
    
    /* Smooth fade for content */
    .tab-content { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0.95; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

    /* Hide checkbox default and use custom if needed, but standard accent-color is fine for MVP */
    input[type="checkbox"] { accent-color: #18181b; width: 1rem; height: 1rem; cursor: pointer; }
  </style>
</head>
<body class="bg-paper text-slate-800 font-sans antialiased min-h-screen selection:bg-zinc-200 selection:text-ink pb-12">

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-paper mb-5">
        <img src="images/logo.svg" alt="Logo" class="w-12 h-12 opacity-90" />
      </div>
      <h1 class="font-serif text-3xl font-bold tracking-tight text-ink mb-2">Novel Proofer</h1>
      <p class="text-slate-500 font-serif tracking-wide text-sm">优雅的中文小说排版校对工具</p>
    </header>

    <!-- Main Card -->
    <main class="bg-white rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-slate-100 overflow-hidden">
      
      <div class="p-6 sm:p-8">
        <form id="mainForm" action="#" method="post" enctype="multipart/form-data">
          
          <!-- File Upload Section -->
          <div class="mb-8">
            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">源文件</label>
            <div class="file-drop group relative w-full p-8 border-2 border-dashed border-slate-200 rounded-xl hover:border-ink/50 hover:bg-slate-50 transition-all duration-200 cursor-pointer text-center" id="fileDrop">
              <div class="pointer-events-none">
                <div class="mb-3 text-slate-400 group-hover:text-ink transition-colors">
                  <svg class="w-8 h-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <div class="text-sm font-medium text-slate-600 group-hover:text-ink transition-colors">点击选择或拖拽 TXT 文件</div>
                <div class="mt-2 text-xs text-slate-400 font-mono" id="fileName">未选择任何文件</div>
              </div>
              <input name="file" type="file" accept=".txt,text/plain" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <button type="button" id="btnValidate" class="px-6 py-2.5 bg-ink hover:bg-zinc-800 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]">
              开始校验
            </button>
            <button type="button" id="btnProcess" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              开始处理
            </button>
            <button type="button" id="btnMerge" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              合并输出
            </button>
            <button type="button" id="btnPause" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              暂停
            </button>
            <button type="button" id="btnRetry" class="px-5 py-2.5 bg-white border border-amber-200 text-amber-700 hover:bg-amber-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              重试失败部分
            </button>
            <button type="button" id="btnCancel" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-red-50 hover:text-red-600 hover:border-red-200 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              取消（可恢复）
            </button>
            <button type="button" id="btnReset" class="px-5 py-2.5 bg-white border border-red-200 text-red-700 hover:bg-red-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              取消并清理
            </button>
            <button type="button" id="btnDownload" class="px-5 py-2.5 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-50 text-sm font-medium rounded-lg transition-colors hidden" disabled>
              下载输出
            </button>
            <button type="button" id="btnLoad" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm font-medium rounded-lg transition-colors">
              加载任务
            </button>
          </div>

          <div class="pt-0 mb-8 flex flex-wrap items-center justify-between gap-3">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" name="cleanup_debug_dir" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
              <span class="text-xs text-slate-500">合并后清理中间产物（output/.jobs）</span>
              <input type="hidden" name="cleanup_debug_dir" value="0">
            </label>
            <div class="text-[10px] text-slate-300">v2.0</div>
          </div>

          <!-- Progress Bar -->
          <div class="mb-8 hidden" id="progress">
            <div class="grid grid-cols-[1fr_auto] items-center gap-x-3 gap-y-1 text-xs font-medium text-slate-500 mb-2" id="meta">
              <span id="metaLeft" class="min-w-0 truncate">准备中</span>
              <span id="metaRight" class="text-right tabular-nums">0%</span>
              <div class="col-span-2 flex flex-wrap items-center gap-2 min-w-0 hidden" id="metaSub">
                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-[11px] text-slate-500 font-mono" id="metaPhaseWrap">
                  <span class="text-slate-400 font-sans">阶段</span>
                  <span id="metaPhase" class="truncate max-w-[10rem]">-</span>
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-[11px] text-slate-500 font-mono hidden" id="metaModelWrap">
                  <span class="text-slate-400 font-sans">模型</span>
                  <span id="metaModel" class="truncate max-w-[18rem]">-</span>
                </span>
              </div>
            </div>
            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              <div class="h-full bg-ink transition-all duration-300 ease-out" style="width: 0%" id="bar"></div>
            </div>
          </div>

          <!-- Output Message Area -->
          <div class="mb-8 hidden" id="out">
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
              <pre id="outText" class="text-xs font-mono text-slate-600 whitespace-pre-wrap break-all"></pre>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="flex gap-6 border-b border-slate-100 mb-6 overflow-x-auto pb-1">
            <button type="button" class="tab-btn active pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="progress">进度</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="slice">切片设置</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="llm">LLM 设置</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="debug">调试信息</button>
          </div>

          <!-- Tab: Progress -->
          <div id="tab-progress" class="tab-content block">
            <div class="grid gap-6">
              <div class="bg-slate-50 border border-slate-100 rounded-xl p-4">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">当前任务</div>
                  <div class="text-xs font-mono text-slate-400" id="jobIdShort">-</div>
                </div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-600">
                  <div class="min-w-0">
                    <span class="text-slate-400">输入：</span><span class="truncate" id="jobInputName">-</span>
                  </div>
                  <div class="min-w-0">
                    <span class="text-slate-400">输出：</span><a class="truncate text-slate-600" id="jobOutputName">-</a>
                  </div>
                </div>
                <div class="mt-2 text-[11px] text-slate-400 font-mono truncate" id="jobOutputPath">-</div>
              </div>

              <!-- Stats -->
              <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100" id="statsBar">
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Total</div>
                  <div class="font-mono font-bold text-lg text-slate-700" id="statTotal">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Done</div>
                  <div class="font-mono font-bold text-lg text-green-600" id="statDone">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Active</div>
                  <div class="font-mono font-bold text-lg text-blue-600" id="statProcessing">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Pending</div>
                  <div class="font-mono font-bold text-lg text-slate-500" id="statPending">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Error</div>
                  <div class="font-mono font-bold text-lg text-red-500" id="statError">0</div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Progress Tab -->

          <!-- Tab: Slice Settings -->
          <div id="tab-slice" class="tab-content hidden">

            <div class="grid gap-8">
              <div class="text-xs text-slate-400 hidden" id="sliceLockHint"></div>

              <!-- Formatting Section -->
              <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">格式化选项</label>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="paragraph_indent" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">段首统一缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="indent_with_fullwidth_space" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">全角空格缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_blank_lines" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">过多空行压缩</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="trim_trailing_spaces" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">去除行尾空格</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_ellipsis" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范省略号 ……</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_em_dash" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范破折号 ——</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_cjk_punctuation" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">中英标点统一</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="fix_cjk_punct_spacing" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">修正标点间距</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_quotes" value="1" class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">引号统一（慎用）</span>
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                   <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出后缀</label>
                    <input name="suffix" type="text" value="_rev" placeholder="_rev" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">分片大小 (200-4000)</label>
                    <input name="max_chunk_chars" type="number" min="200" max="4000" step="100" value="2000" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出预览</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono text-slate-400 truncate select-all" id="outputPreview">output/&lt;job_id&gt;_input_rev.txt</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
          <!-- End Slice Settings Tab -->

          <!-- Tab: LLM Settings -->
          <div id="tab-llm" class="tab-content hidden">

            <div class="grid gap-6">
              <div class="text-xs text-slate-400 hidden" id="llmLockHint"></div>

              <div>
                <div class="flex items-center justify-between mb-4">
                  <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">LLM 配置（用于处理/重试）</label>
                  <div class="flex items-center gap-2">
                    <button type="button" class="text-xs text-ink hover:underline font-medium" id="btnSaveLlmDefaults">保存为默认</button>
                    <span id="llmDirtyHint" class="text-[10px] text-amber-500 font-bold hidden">● 未保存</span>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Base URL</label>
                    <input name="llm_base_url" type="text" placeholder="https://api.openai.com/v1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Model Name</label>
                    <input name="llm_model" type="text" placeholder="zai-glm-4.6 / gemini-2.5-pro / minimax-m2.1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">API Key</label>
                    <div class="relative">
                      <input name="llm_api_key" type="password" placeholder="sk-..." class="w-full pl-3 pr-12 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                      <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 hover:text-ink px-1.5 py-0.5" id="btnToggleApiKey">SHOW</button>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Temp</label>
                    <input name="llm_temperature" type="number" step="0.1" value="0" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Timeout (秒)</label>
                    <input name="llm_timeout_seconds" type="number" step="1" value="180" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">并发</label>
                    <input name="llm_max_concurrency" type="number" min="1" step="1" value="20" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-slate-500 mb-1.5">额外参数 (JSON)</label>
                  <textarea name="llm_extra_params" placeholder='{"max_tokens": 4096}' class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono h-20 resize-y focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow"></textarea>
                </div>
              </div>
            </div>
          </div>
          <!-- End LLM Settings Tab -->

          <!-- Tab: Debug -->
          <div id="tab-debug" class="tab-content hidden">

            <!-- Filter -->
             <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button type="button" class="filter-btn active px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="all">全部</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="error">错误</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="active">处理中</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="pending">待处理</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="done">完成</button>
             </div>

            <!-- Table -->
            <div class="border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm" id="chunksTableWrap">
               <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-left text-xs table-fixed">
                  <thead class="bg-slate-50 text-slate-500 font-medium sticky top-0 z-10 shadow-sm border-b border-slate-200">
                    <tr>
                      <th class="py-3 px-2 w-12 text-center font-semibold text-slate-600">#</th>
                      <th class="py-3 px-2 w-16 text-center font-semibold text-slate-600">状态</th>
                      <th class="py-3 px-2 w-40 text-center font-semibold text-slate-600">LLM 模型</th>
                      <th class="py-3 px-2 w-12 text-center font-semibold text-slate-600">重试</th>
                      <th class="py-3 px-2 w-28 text-center font-semibold text-slate-600">Chars (In/Out)</th>
                      <th class="py-3 px-2 text-left font-semibold text-slate-600">信息</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white" id="chunksBody">
                    <!-- JS rendered -->
                  </tbody>
                </table>
               </div>
            </div>
            
            <div id="noChunksHint" class="text-center py-12 text-slate-400 text-sm hidden">
              暂无分片数据，请先开始校对任务。
            </div>

          </div>
          <!-- End Debug Tab -->

        </form>
      </div>
    </main>

    <div class="mt-8 text-center">
       <div class="inline-block px-4 py-2 rounded-full bg-white border border-slate-100 shadow-sm text-xs text-slate-400">
         Powered by LLM & Heuristic Rules
       </div>
    </div>
    
  </div>

  <script>
    // DOM Elements
    const form = document.getElementById('mainForm');
    const out = document.getElementById('out');
    const outText = document.getElementById('outText');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const meta = document.getElementById('meta');
    const metaLeft = document.getElementById('metaLeft');
    const metaRight = document.getElementById('metaRight');
    const metaSub = document.getElementById('metaSub');
    const metaPhase = document.getElementById('metaPhase');
    const metaModelWrap = document.getElementById('metaModelWrap');
    const metaModel = document.getElementById('metaModel');
    const btnValidate = document.getElementById('btnValidate');
    const btnProcess = document.getElementById('btnProcess');
    const btnMerge = document.getElementById('btnMerge');
    const btnPause = document.getElementById('btnPause');
    const btnRetry = document.getElementById('btnRetry');
    const btnCancel = document.getElementById('btnCancel');
    const btnReset = document.getElementById('btnReset');
    const btnDownload = document.getElementById('btnDownload');
    const btnLoad = document.getElementById('btnLoad');
    const btnSaveLlmDefaults = document.getElementById('btnSaveLlmDefaults');
    const llmDirtyHint = document.getElementById('llmDirtyHint');
    const btnToggleApiKey = document.getElementById('btnToggleApiKey');
    const fileInput = form.querySelector('input[name="file"]');
    const suffixInput = form.querySelector('input[name="suffix"]');
    const outputPreview = document.getElementById('outputPreview');
    const fileDrop = document.getElementById('fileDrop');
    const fileName = document.getElementById('fileName');
    const jobIdShort = document.getElementById('jobIdShort');
    const jobInputName = document.getElementById('jobInputName');
    const jobOutputName = document.getElementById('jobOutputName');
    const jobOutputPath = document.getElementById('jobOutputPath');
    const sliceLockHint = document.getElementById('sliceLockHint');
    const llmLockHint = document.getElementById('llmLockHint');

    // Debug tab elements
    const chunksBody = document.getElementById('chunksBody');
    const noChunksHint = document.getElementById('noChunksHint');
    const chunksTableWrap = document.getElementById('chunksTableWrap');
    const statTotal = document.getElementById('statTotal');
    const statDone = document.getElementById('statDone');
    const statProcessing = document.getElementById('statProcessing');
    const statPending = document.getElementById('statPending');
    const statError = document.getElementById('statError');

    let currentJobId = null;
    let currentJobState = null;
    let currentJobPhase = null;
    let currentFilter = 'all';
    let activeTab = 'progress';
    let forceChunksFetch = false;
    let chunksData = [];
    let chunkCounts = null;
    let totalChunksFromServer = 0;
    let chunksFetchInFlight = false;

    const UI_STATE_KEY = 'novel_proofer.ui_state.v1';
    const UI_STATE_FIELDS = [
      'suffix',
      'max_chunk_chars',
      'paragraph_indent',
      'indent_with_fullwidth_space',
      'normalize_blank_lines',
      'trim_trailing_spaces',
      'normalize_ellipsis',
      'normalize_em_dash',
      'normalize_cjk_punctuation',
      'fix_cjk_punct_spacing',
      'normalize_quotes',
      'cleanup_debug_dir',
    ];

    function _uiStateElement(name) {
      if (name === 'cleanup_debug_dir') {
        return form.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]');
      }
      return form.querySelector(`[name="${name}"]`);
    }

    function loadUiState() {
      try {
        const raw = localStorage.getItem(UI_STATE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        if (!state || typeof state !== 'object') return;
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          if (el.type === 'checkbox') {
            el.checked = !!state[name];
          } else if (state[name] != null) {
            el.value = String(state[name]);
          }
        }
      } catch (e) {}
    }

    function saveUiState() {
      try {
        const state = {};
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          state[name] = (el.type === 'checkbox') ? !!el.checked : String(el.value || '');
        }
        localStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
      } catch (e) {}
    }

    function _previewOutputPath() {
      const file = fileInput?.files?.[0];
      const rawName = String(file?.name || 'input.txt');
      const name = rawName.split(/[\\/]/).pop() || 'input.txt';
      const dot = name.lastIndexOf('.');
      const stem = (dot > 0) ? name.slice(0, dot) : name;
      const ext = (dot > 0) ? name.slice(dot) : '.txt';
      const suffix = String(suffixInput?.value || '_rev').trim() || '_rev';
      return `output/<job_id>_${stem}${suffix}${ext}`;
    }

    function refreshOutputPreview() {
      if (!outputPreview) return;
      outputPreview.textContent = _previewOutputPath();
    }

    function refreshFileName() {
      const file = fileInput?.files?.[0];
      if (fileName) fileName.textContent = file ? file.name : '未选择任何文件';
      refreshOutputPreview();
    }

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
      activeTab = tabName;
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-600', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-400', btn.dataset.tab !== tabName);
      });
      tabContents.forEach(content => {
          if (content.id === 'tab-' + tabName) {
              content.classList.remove('hidden');
              content.classList.add('block');
          } else {
              content.classList.add('hidden');
              content.classList.remove('block');
          }
      });
      
      localStorage.setItem('activeTab', tabName);
      if (tabName === 'debug' && currentJobId) {
        forceChunksFetch = true;
        refreshChunksNow(currentJobId);
      }
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Restore tab from localStorage
    const savedTab = localStorage.getItem('activeTab');
    switchTab(savedTab || 'progress');

    loadUiState();
    refreshFileName();
    UI_STATE_FIELDS.forEach((name) => {
      const el = _uiStateElement(name);
      if (!el) return;
      el.addEventListener('input', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
      el.addEventListener('change', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
    });
    fileInput?.addEventListener('change', refreshFileName);
    if (fileInput && fileDrop) {
      const addDrag = () => {
          fileDrop.classList.add('border-ink', 'bg-slate-50');
      };
      const rmDrag = () => {
          fileDrop.classList.remove('border-ink', 'bg-slate-50');
      };
      fileInput.addEventListener('dragenter', addDrag);
      fileInput.addEventListener('dragleave', rmDrag);
      fileInput.addEventListener('drop', () => {
        rmDrag();
        // Let the browser populate input.files, then refresh UI.
        setTimeout(refreshFileName, 0);
      });
    }

    // Filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        filterBtns.forEach(b => b.classList.toggle('active', b === btn));
        if (activeTab === 'debug' && currentJobId) {
          forceChunksFetch = true;
          refreshChunksNow(currentJobId);
        } else {
          renderChunksTable();
        }
      });
    });

    function getStatusBadge(state) {
      const config = {
          pending: { class: 'bg-slate-100 text-slate-500', label: '待处理' },
          processing: { class: 'bg-blue-50 text-blue-600', label: '处理中' },
          done: { class: 'bg-green-50 text-green-600', label: '完成' },
          error: { class: 'bg-red-50 text-red-600', label: '错误' },
          // retrying is a subset of "processing" (backoff + next attempt), keep state but merge display.
          retrying: { class: 'bg-amber-50 text-amber-600', label: '处理中' }
      };
      
      const c = config[state] || config.pending;
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${c.class}">${c.label}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncateStr(s, maxLen) {
      const str = String(s || '');
      const n = Number(maxLen || 0);
      if (!Number.isFinite(n) || n <= 0) return str;
      if (str.length <= n) return str;
      return str.slice(0, n) + '…';
    }

    function tryParseJson(s) {
      try {
        return JSON.parse(s);
      } catch (e) {
        return null;
      }
    }

    function formatErrorDisplay(code, message) {
      const codeStr = (code == null || code === '') ? '' : String(code);
      const msg = (message == null) ? '' : String(message).trim();

      if (!codeStr && !msg) return null;

      const httpMatch = msg.match(/^HTTP\s+(\d+)\s+from\s+LLM:\s*(.*)$/i);
      if (httpMatch) {
        const httpCode = httpMatch[1] || codeStr || '';
        const body = String(httpMatch[2] || '').trim();

        let reason = '';
        if (body) {
          const parsed = (body.startsWith('{') || body.startsWith('[')) ? tryParseJson(body) : null;
          if (parsed && parsed.error && parsed.error.message) reason = String(parsed.error.message);
          else if (parsed && parsed.message) reason = String(parsed.message);
          else reason = body;
        }

        const brief = httpCode ? `HTTP ${httpCode}` : 'HTTP error';
        const detail = reason ? `${brief}: ${reason}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      if (/LLM output empty/i.test(msg)) {
        return { brief: 'LLM output empty', detail: 'LLM output empty' };
      }

      if (/LLM output too short/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too short (ratio=${m[1]})` : 'LLM output too short';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (/LLM output too long/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too long (ratio=${m[1]})` : 'LLM output too long';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (codeStr) {
        const brief = `HTTP ${codeStr}`;
        const detail = msg ? `${brief}: ${msg}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      const brief = truncateStr(msg, 60);
      return { brief, detail: truncateStr(msg, 300) };
    }

    function renderChunksTable() {
      if (!chunksData || chunksData.length === 0) {
        noChunksHint.classList.remove('hidden');
        chunksTableWrap.classList.add('hidden');
        if (currentJobId) {
          if (currentFilter === 'all') {
            noChunksHint.textContent = '暂无分片数据（可切换到调试信息页以加载）。';
          } else {
            noChunksHint.textContent = '当前过滤条件下无匹配分片。';
          }
        } else {
          noChunksHint.textContent = '暂无分片数据，请先开始校对任务。';
        }
        return;
      }

      noChunksHint.classList.add('hidden');
      chunksTableWrap.classList.remove('hidden');

       const rows = chunksData.slice(0, 500).map(c => {
         let inOut = '-';
         if (c.input_chars != null && c.output_chars != null) inOut = `${c.input_chars} / ${c.output_chars}`;
         else if (c.input_chars != null) inOut = `${c.input_chars} / -`;

          const llmFull = (c.llm_model != null) ? String(c.llm_model) : '';
          // CSS truncation for LLM model
          const llmCell = llmFull
            ? `<div class="truncate max-w-[9rem] mx-auto text-slate-600 font-medium" title="${escapeHtml(llmFull)}">${escapeHtml(llmFull)}</div>`
            : `<span class="text-slate-300">-</span>`;

           const errCode = (c.last_error_code != null) ? String(c.last_error_code) : '';
           const errFull = c.last_error_message ? String(c.last_error_message) : '';
           const err = formatErrorDisplay(errCode, errFull);
           let errMsg = '-';
           if (err) {
             const detail = escapeHtml(err.detail);
             const brief = escapeHtml(err.brief);
             if (c.state === 'error') {
               errMsg = `<span class="text-red-600 font-medium cursor-help border-b border-dotted border-red-300 hover:text-red-700" title="${detail}">${brief}</span>`;
             } else if (c.state === 'retrying') {
              errMsg = `<span class="text-amber-600 font-medium cursor-help border-b border-dotted border-amber-300 hover:text-amber-700" title="${detail}">${brief}</span>`;
            } else if (c.state === 'done') {
              const retries = Number(c.retries || 0);
              if (retries > 0) {
                errMsg = `<span class="text-slate-400 cursor-help border-b border-dotted border-slate-300 hover:text-slate-600" title="${detail}">曾重试: ${brief}</span>`;
              }
            } else {
              errMsg = `<span class="text-slate-400 cursor-help border-b border-dotted border-slate-300" title="${detail}">${brief}</span>`;
            }
          }

         return `<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
           <td class="py-3 px-2 text-slate-400 font-mono text-center whitespace-nowrap text-[11px]">${c.index}</td>
           <td class="py-3 px-2 text-center whitespace-nowrap">${getStatusBadge(c.state)}</td>
           <td class="py-3 px-2 whitespace-nowrap text-xs text-center">${llmCell}</td>
           <td class="py-3 px-2 text-slate-400 text-center whitespace-nowrap font-mono text-xs">${c.retries || 0}</td>
           <td class="py-3 px-2 text-slate-400 font-mono text-[11px] text-center whitespace-nowrap tracking-tight">${inOut}</td>
           <td class="py-3 px-2 text-slate-600 text-xs text-left">${errMsg}</td>
         </tr>`;
       }).join('');


      chunksBody.innerHTML = rows;
    }

    function updateStats() {
      const counts = chunkCounts || {};
      statTotal.textContent = String(totalChunksFromServer || 0);
      statDone.textContent = String(counts.done || 0);
      statProcessing.textContent = String((counts.processing || 0) + (counts.retrying || 0));
      statPending.textContent = String(counts.pending || 0);
      statError.textContent = String(counts.error || 0);
    }

    function showChunks(data) {
      if (!data || !Array.isArray(data.chunks)) return;

      chunksData = data.chunks;
      chunkCounts = data.chunk_counts || null;
      totalChunksFromServer = Number(data?.job?.progress?.total_chunks || 0);
      updateStats();
      renderChunksTable();
    }

    async function refreshChunksNow(jobId) {
      if (!jobId) return;
      if (chunksFetchInFlight) return;
      chunksFetchInFlight = true;
      try {
        const q = new URLSearchParams({ chunks: '1' });
        q.set('chunk_state', currentFilter);
        q.set('limit', '500');
        q.set('offset', '0');

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        showChunks(data);
      } catch (e) {
        show(String(e));
      } finally {
        chunksFetchInFlight = false;
      }
    }

    function show(obj) {
      out.classList.remove('hidden');
      outText.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    function _phaseLabel(phase) {
      const v = String(phase || '').toLowerCase();
      const map = { validate: '校验', process: '处理', merge: '合并', done: '完成' };
      return map[v] || (v || '-');
    }

    function _stateLabel(state) {
      const v = String(state || '').toLowerCase();
      const map = { queued: '排队中', running: '运行中', paused: '已暂停', done: '已完成', cancelled: '已取消', error: '出错' };
      return map[v] || (v || '-');
    }

    function setJobCard(job) {
      const j = job || null;
      if (jobIdShort) jobIdShort.textContent = j?.id ? String(j.id).slice(0, 8) : '-';
      if (jobInputName) jobInputName.textContent = j?.input_filename ? String(j.input_filename) : '-';
      if (jobOutputName) {
        const outName = j?.output_filename ? String(j.output_filename) : '-';
        jobOutputName.textContent = outName;
        const isDone = String(j?.state || '').toLowerCase() === 'done' && !!j?.id && !!j?.output_path;
        if (isDone && outName !== '-') {
          jobOutputName.classList.add('text-ink', 'hover:underline');
          jobOutputName.classList.remove('text-slate-600');
          jobOutputName.setAttribute('href', `api/v1/jobs/${encodeURIComponent(j.id)}/download`);
          jobOutputName.setAttribute('download', outName);
        } else {
          jobOutputName.classList.remove('text-ink', 'hover:underline');
          jobOutputName.classList.add('text-slate-600');
          jobOutputName.removeAttribute('href');
          jobOutputName.removeAttribute('download');
        }
      }
      if (jobOutputPath) jobOutputPath.textContent = j?.output_path ? String(j.output_path) : '-';
    }

    function setProgressFromJob(job) {
      if (!job) {
        progress.classList.add('hidden');
        if (metaSub) metaSub.classList.add('hidden');
        if (metaModelWrap) metaModelWrap.classList.add('hidden');
        return;
      }

      progress.classList.remove('hidden');
      const state = String(job.state || '');
      const phase = String(job.phase || '');
      const done = Number(job?.progress?.done_chunks || 0);
      const total = Number(job?.progress?.total_chunks || 0);
      const pct = total > 0 ? Math.floor((done / total) * 100) : (state === 'done' ? 100 : 0);
      bar.style.width = pct + '%';

      const phaseLabel = _phaseLabel(phase);
      let left = _stateLabel(state);
      if (state === 'running' && phase === 'validate') left = '正在校验…';
      if (state === 'paused' && phase === 'process') left = (done > 0 ? '处理已暂停' : '校验完成，等待开始处理');
      if (state === 'running' && phase === 'process') left = '正在处理…';
      if (state === 'error' && phase === 'process') left = '处理出错';
      if (state === 'paused' && phase === 'merge') left = '处理完成，等待合并输出';
      if (state === 'running' && phase === 'merge') left = '正在合并输出…';
      if (state === 'done') left = '已完成';

      const counter = total > 0 ? ` ${done}/${total}` : '';
      metaLeft.textContent = `${left}${counter}`;
      metaRight.textContent = pct + '%';

      if (metaSub) metaSub.classList.remove('hidden');
      if (metaPhase) metaPhase.textContent = phaseLabel;

      const model = job?.llm_model ? String(job.llm_model).trim() : '';
      if (metaModel) metaModel.textContent = model || '-';
      if (metaModelWrap) metaModelWrap.classList.toggle('hidden', !model);
    }

    function _setVisible(el, visible) {
      if (!el) return;
      el.classList.toggle('hidden', !visible);
    }

    function _setDisabled(el, disabled) {
      if (!el) return;
      el.disabled = !!disabled;
      el.classList.toggle('opacity-50', !!disabled);
      el.classList.toggle('cursor-not-allowed', !!disabled);
    }

    const SLICE_FIELDS = [
      'suffix',
      'max_chunk_chars',
      'paragraph_indent',
      'indent_with_fullwidth_space',
      'normalize_blank_lines',
      'trim_trailing_spaces',
      'normalize_ellipsis',
      'normalize_em_dash',
      'normalize_cjk_punctuation',
      'fix_cjk_punct_spacing',
      'normalize_quotes',
    ];

    const LLM_FIELDS = [
      'llm_base_url',
      'llm_model',
      'llm_api_key',
      'llm_temperature',
      'llm_timeout_seconds',
      'llm_max_concurrency',
      'llm_extra_params',
    ];

    function _setFieldsDisabled(names, disabled) {
      for (const name of names) {
        const el = form.querySelector(`[name="${name}"]`);
        if (!el) continue;
        el.disabled = !!disabled;
        el.classList.toggle('opacity-50', !!disabled);
        el.classList.toggle('cursor-not-allowed', !!disabled);
      }
    }

    function refreshLocks(job) {
      const hasJob = !!job;
      const llmLocked = hasJob && ['queued', 'running'].includes(String(job.state || ''));

      _setFieldsDisabled(SLICE_FIELDS, hasJob);
      if (sliceLockHint) {
        sliceLockHint.classList.toggle('hidden', !hasJob);
        if (hasJob) sliceLockHint.textContent = '当前已关联任务，切片设置已锁定（要修改请先“取消（可恢复）/取消并清理”回到初始态）。';
      }

      _setFieldsDisabled(LLM_FIELDS, llmLocked);
      if (llmLockHint) {
        llmLockHint.classList.toggle('hidden', !llmLocked);
        if (llmLocked) llmLockHint.textContent = '任务运行中，LLM 配置已锁定（暂停/出错后可修改并用于继续/重试）。';
      }
    }

    function refreshActionButtons(job) {
      const state = String(job?.state || '').toLowerCase();
      const phase = String(job?.phase || '').toLowerCase();
      const hasJob = !!job;

      // Validate: start new job OR resume validate if paused in validate phase.
      const canResumeValidate = hasJob && state === 'paused' && phase === 'validate';
      _setVisible(btnValidate, !hasJob || canResumeValidate);
      if (btnValidate) btnValidate.textContent = canResumeValidate ? '继续校验' : '开始校验';
      _setDisabled(btnValidate, false);

      const canProcess = hasJob && state === 'paused' && phase === 'process';
      _setVisible(btnProcess, canProcess);
      _setDisabled(btnProcess, !canProcess);
      if (btnProcess) {
        const done = Number(job?.progress?.done_chunks || 0);
        btnProcess.textContent = (canProcess && done > 0) ? '继续处理' : '开始处理';
      }

      const canMerge = hasJob && state === 'paused' && phase === 'merge';
      _setVisible(btnMerge, canMerge);
      _setDisabled(btnMerge, !canMerge);

      const canPause = hasJob && (state === 'queued' || state === 'running');
      _setVisible(btnPause, canPause);
      _setDisabled(btnPause, !canPause);

      const canRetry = hasJob && state === 'error';
      _setVisible(btnRetry, canRetry);
      _setDisabled(btnRetry, !canRetry);

      const showCancel = hasJob;
      _setVisible(btnCancel, showCancel);
      _setDisabled(btnCancel, !showCancel);
      if (btnCancel) {
        if (state === 'done') btnCancel.textContent = '新任务';
        else if (state === 'paused' || state === 'error') btnCancel.textContent = '返回初始态';
        else btnCancel.textContent = '取消（可恢复）';
      }

      const showReset = hasJob;
      _setVisible(btnReset, showReset);
      _setDisabled(btnReset, !showReset);
      if (btnReset) {
        btnReset.textContent = (state === 'done') ? '清理任务记录' : '取消并清理';
      }

      const canDownload = hasJob && state === 'done';
      _setVisible(btnDownload, canDownload);
      _setDisabled(btnDownload, !canDownload);

      _setVisible(btnLoad, true);
      _setDisabled(btnLoad, false);
    }

    function _llmSnapshot() {
      const fd = new FormData(form);
      return JSON.stringify({
        base_url: String(fd.get('llm_base_url') || ''),
        model: String(fd.get('llm_model') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        temperature: String(fd.get('llm_temperature') || ''),
        timeout_seconds: String(fd.get('llm_timeout_seconds') || ''),
        max_concurrency: String(fd.get('llm_max_concurrency') || ''),
        extra_params: String(fd.get('llm_extra_params') || '').trim(),
      });
    }

    let _llmSavedSnapshot = null;

    function _setLlmDirty(dirty) {
      llmDirtyHint.classList.toggle('hidden', !dirty);
      llmDirtyHint.classList.toggle('inline', dirty);
      btnSaveLlmDefaults.disabled = !dirty;
      btnSaveLlmDefaults.classList.toggle('opacity-50', !dirty);
    }

    function _refreshLlmDirty() {
      if (_llmSavedSnapshot == null) return;
      _setLlmDirty(_llmSnapshot() !== _llmSavedSnapshot);
    }

    async function loadLlmDefaults() {
      try {
        const res = await fetch('api/v1/settings/llm');
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        const llm = data?.llm || {};
        const setIfProvided = (name, value) => {
          if (value === undefined || value === null) return;
          const el = form.querySelector(`[name="${name}"]`);
          if (!el) return;
          el.value = String(value);
        };

        setIfProvided('llm_base_url', llm.base_url);
        setIfProvided('llm_model', llm.model);
        setIfProvided('llm_api_key', llm.api_key);
        if (llm.temperature !== undefined && llm.temperature !== null) setIfProvided('llm_temperature', llm.temperature);
        if (llm.timeout_seconds !== undefined && llm.timeout_seconds !== null) setIfProvided('llm_timeout_seconds', llm.timeout_seconds);
        if (llm.max_concurrency !== undefined && llm.max_concurrency !== null) setIfProvided('llm_max_concurrency', llm.max_concurrency);
        if (llm.extra_params !== undefined && llm.extra_params !== null) {
          const el = form.querySelector('[name="llm_extra_params"]');
          if (el) el.value = JSON.stringify(llm.extra_params, null, 2);
        }
      } catch (e) {
        show(String(e));
      } finally {
        _llmSavedSnapshot = _llmSnapshot();
        _setLlmDirty(false);
      }
    }

    async function requestSaveLlmDefaults() {
      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = {
        llm: {
          base_url: String(fd.get('llm_base_url') || ''),
          api_key: String(fd.get('llm_api_key') || ''),
          model: String(fd.get('llm_model') || ''),
          temperature: Number(fd.get('llm_temperature') || 0),
          timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
          max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
          extra_params: extra.value,
        }
      };
      try {
        const res = await fetch('api/v1/settings/llm', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnSaveLlmDefaults.addEventListener('click', async () => {
      btnSaveLlmDefaults.disabled = true;
      const r = await requestSaveLlmDefaults();
      if (!r.ok) {
        show(r.error);
        _refreshLlmDirty();
        return;
      }
      show('默认 LLM 配置已保存。');
      _llmSavedSnapshot = _llmSnapshot();
      _setLlmDirty(false);
    });

    ['llm_base_url', 'llm_model', 'llm_api_key', 'llm_temperature', 'llm_timeout_seconds', 'llm_max_concurrency', 'llm_extra_params'].forEach((name) => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;
      el.addEventListener('input', _refreshLlmDirty);
      el.addEventListener('change', _refreshLlmDirty);
    });

    btnToggleApiKey.addEventListener('click', () => {
      const el = form.querySelector('[name="llm_api_key"]');
      if (!el) return;
      if (el.type === 'password') {
        el.type = 'text';
        btnToggleApiKey.textContent = 'HIDE';
      } else {
        el.type = 'password';
        btnToggleApiKey.textContent = 'SHOW';
      }
    });

    function parseExtraParamsFromFormData(fd) {
      const raw = String(fd.get('llm_extra_params') || '').trim();
      if (!raw) return { ok: true, value: null };
      try {
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) {
          return { ok: false, error: '额外参数必须是 JSON 对象（例如 {"max_tokens": 4096}）。' };
        }
        return { ok: true, value: obj };
      } catch (e) {
        return { ok: false, error: '额外参数 JSON 无效，请检查括号/引号/逗号。' };
      }
    }

    function buildLlmOptions(fd, extraParamsValue) {
      return {
        base_url: String(fd.get('llm_base_url') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        model: String(fd.get('llm_model') || ''),
        temperature: Number(fd.get('llm_temperature') || 0),
        timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
        max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
        extra_params: extraParamsValue,
      };

    }

    function buildJobOptions(fd, extraParamsValue) {
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      return {
        format: {
          max_chunk_chars: Number(fd.get('max_chunk_chars') || 2000),
          paragraph_indent: fd.get('paragraph_indent') != null,
          indent_with_fullwidth_space: fd.get('indent_with_fullwidth_space') != null,
          normalize_blank_lines: fd.get('normalize_blank_lines') != null,
          trim_trailing_spaces: fd.get('trim_trailing_spaces') != null,
          normalize_ellipsis: fd.get('normalize_ellipsis') != null,
          normalize_em_dash: fd.get('normalize_em_dash') != null,
          normalize_cjk_punctuation: fd.get('normalize_cjk_punctuation') != null,
          fix_cjk_punct_spacing: fd.get('fix_cjk_punct_spacing') != null,
          normalize_quotes: fd.get('normalize_quotes') != null,
        },
        llm: buildLlmOptions(fd, extraParamsValue),
        output: {
          suffix: String(fd.get('suffix') || '_rev'),
          cleanup_debug_dir: cleanupDebugDir,
        },
      };
    }

    async function requestCancel(jobId) {
      if (!jobId) return;
      try {
        await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cancel`, { method: 'POST' });
      } catch (e) {}
    }

    async function requestPause(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/pause`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestResume(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestRetryFailed(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/retry-failed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestMerge(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      const payload = { cleanup_debug_dir: cleanupDebugDir };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/merge`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestReset(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/reset`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestJobSummary(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      const q = new URLSearchParams({ chunks: '1', chunk_state: 'all', limit: '1', offset: '0' });
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data, status: res.status };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestJobList() {
      try {
        const res = await fetch('api/v1/jobs?limit=50');
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    const ATTACHED_JOB_KEY = 'novel_proofer.attached_job_id.v2';
    let pollTimer = null;
    let pollJobId = null;
    let pollInFlight = false;

    function stopPolling() {
      if (!pollTimer) return;
      clearInterval(pollTimer);
      pollTimer = null;
      pollJobId = null;
    }

    function ensurePolling(jobId) {
      if (pollTimer && pollJobId === jobId) return;
      stopPolling();
      pollJobId = jobId;
      pollTimer = setInterval(() => refreshJobOnce(jobId), 1000);
    }

    function detachUi({ clearFile = true } = {}) {
      stopPolling();
      pollInFlight = false;

      currentJobId = null;
      currentJobState = null;
      currentJobPhase = null;
      try { localStorage.removeItem(ATTACHED_JOB_KEY); } catch (e) {}

      chunksData = [];
      chunkCounts = null;
      totalChunksFromServer = 0;
      updateStats();
      renderChunksTable();

      setJobCard(null);
      setProgressFromJob(null);
      refreshLocks(null);
      refreshActionButtons(null);
      out.classList.add('hidden');
      outText.textContent = '';

      if (clearFile && fileInput) {
        fileInput.value = '';
        refreshFileName();
      }
    }

    async function refreshJobOnce(jobId) {
      if (!jobId || currentJobId !== jobId) return;
      if (pollInFlight) return;
      pollInFlight = true;
      try {
        const r = await requestJobSummary(jobId);
        if (!jobId || currentJobId !== jobId) return;
        if (!r.ok) {
          // 404 means job removed (e.g., reset finished)
          if (r.status === 404) {
            detachUi();
            show('任务已被清理或不存在。');
            return;
          }
          show(r.error);
          return;
        }

        const job = r?.data?.job;
        currentJobState = job?.state || null;
        currentJobPhase = job?.phase || null;

        // Sync slice settings from job snapshot (do not persist to localStorage).
        const fmt = job?.format || null;
        if (fmt) {
          const setCheck = (name, val) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (el) el.checked = !!val;
          };
          const setNum = (name, val) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (el && val != null) el.value = String(val);
          };
          setNum('max_chunk_chars', fmt.max_chunk_chars);
          setCheck('paragraph_indent', fmt.paragraph_indent);
          setCheck('indent_with_fullwidth_space', fmt.indent_with_fullwidth_space);
          setCheck('normalize_blank_lines', fmt.normalize_blank_lines);
          setCheck('trim_trailing_spaces', fmt.trim_trailing_spaces);
          setCheck('normalize_ellipsis', fmt.normalize_ellipsis);
          setCheck('normalize_em_dash', fmt.normalize_em_dash);
          setCheck('normalize_cjk_punctuation', fmt.normalize_cjk_punctuation);
          setCheck('fix_cjk_punct_spacing', fmt.fix_cjk_punct_spacing);
          setCheck('normalize_quotes', fmt.normalize_quotes);
        }

        setJobCard(job);
        setProgressFromJob(job);
        refreshLocks(job);
        refreshActionButtons(job);

        chunkCounts = r?.data?.chunk_counts || null;
        totalChunksFromServer = Number(job?.progress?.total_chunks || 0);
        updateStats();

        if (job?.state === 'error') {
          show(job?.error || '处理出错');
        } else if (job?.state === 'paused' && job?.phase === 'process') {
          const done = Number(job?.progress?.done_chunks || 0);
          show(done > 0 ? '处理已暂停：可点击“继续处理”。' : '校验完成：可点击“开始处理”。');
        } else if (job?.state === 'paused' && job?.phase === 'merge') {
          show('处理完成：可点击“合并输出”。');
        } else if (job?.state === 'done') {
          show(job?.output_path ? `完成。输出：${job.output_path}\n可点击“下载输出”或“新任务”。` : '完成。已输出到项目 output/ 目录。');
        }

        const counts = chunkCounts || {};
        const active = Number(counts.processing || 0) + Number(counts.retrying || 0);
        const stLower = String(job?.state || '').toLowerCase();
        const shouldPoll = stLower === 'queued' || stLower === 'running' || (stLower === 'paused' && active > 0);
        if (shouldPoll) ensurePolling(jobId);
        else stopPolling();

        if (activeTab === 'debug') {
          forceChunksFetch = true;
          await refreshChunksNow(jobId);
        }
      } finally {
        pollInFlight = false;
      }
    }

    async function attachJob(jobId) {
      const jid = String(jobId || '').trim();
      if (!jid) return;
      currentJobId = jid;
      try { localStorage.setItem(ATTACHED_JOB_KEY, jid); } catch (e) {}

      // Reset debug view but keep form values (they will be overwritten by job.format when fetched).
      chunksData = [];
      chunkCounts = null;
      totalChunksFromServer = 0;
      updateStats();
      renderChunksTable();

      ensurePolling(jid);
      await refreshJobOnce(jid);
    }

    btnPause?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      _setDisabled(btnPause, true);
      show('正在暂停…');
      const r = await requestPause(jobId);
      if (!r.ok) {
        show(r.error);
        _setDisabled(btnPause, false);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnRetry?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('准备重试失败分片…');
      const r = await requestRetryFailed(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnProcess?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('开始处理…');
      const r = await requestResume(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnMerge?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('开始合并输出…');
      const r = await requestMerge(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnDownload?.addEventListener('click', () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const url = `api/v1/jobs/${encodeURIComponent(jobId)}/download`;
      const a = document.createElement('a');
      a.href = url;
      a.download = '';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnValidate?.addEventListener('click', async () => {
      // Start new validation when idle; resume validate only if paused in validate phase.
      if (!currentJobId) {
        form.requestSubmit();
        return;
      }
      if (currentJobState === 'paused' && currentJobPhase === 'validate') {
        const jobId = currentJobId;
        show('继续校验…');
        const r = await requestResume(jobId);
        if (!r.ok) {
          show(r.error);
          return;
        }
        await refreshJobOnce(jobId);
      }
    });

    btnCancel?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const st = String(currentJobState || '').toLowerCase();
      if (st === 'done') {
        detachUi({ clearFile: true });
        show('已返回初始态。可通过“加载任务”查看历史任务/输出。');
        return;
      }

      const confirmMsg = (st === 'queued' || st === 'running')
        ? '确认“取消（可恢复）”？将停止当前任务并返回初始态，可稍后通过“加载任务”继续。'
        : '确认返回初始态？该任务可稍后通过“加载任务”继续/查看。';
      if (!confirm(confirmMsg)) return;

      show('正在返回初始态…');
      await requestCancel(jobId);
      detachUi({ clearFile: true });
      show('已返回初始态。可通过“加载任务”继续该任务。');
    });

    btnReset?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const st = String(currentJobState || '').toLowerCase();
      const confirmMsg = (st === 'done')
        ? '确认“清理任务记录”？该任务的中间态/状态记录将被删除且不可恢复（不会删除最终输出文件 output/）。'
        : '确认“取消并清理”？该任务中间产物与状态将被删除且不可恢复。';
      if (!confirm(confirmMsg)) return;

      show((st === 'done') ? '正在清理任务记录…' : '正在取消并清理…');
      const r = await requestReset(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      detachUi({ clearFile: true });
      show('已提交清理请求。');
    });

    btnLoad?.addEventListener('click', async () => {
      const r = await requestJobList();
      if (!r.ok) {
        show(r.error);
        return;
      }
      const jobs = Array.isArray(r?.data?.jobs) ? r.data.jobs : [];
      if (!jobs.length) {
        show('暂无可加载任务。');
        return;
      }

      const lines = jobs.slice(0, 20).map((j, i) => {
        const id8 = j?.id ? String(j.id).slice(0, 8) : '-';
        const st = `${j?.state || '-'}:${j?.phase || '-'}`;
        const prog = `${j?.progress?.done_chunks || 0}/${j?.progress?.total_chunks || 0}`;
        const name = j?.input_filename ? String(j.input_filename) : '';
        return `${i + 1}) ${id8}  ${st}  ${prog}  ${name}`;
      }).join('\n');

      const choice = prompt(`选择要加载的任务：\n\n${lines}\n\n输入编号(1-20)或完整 job_id：`);
      if (!choice) return;
      const trimmed = String(choice).trim();
      const idx = Number(trimmed);
      let chosenId = null;
      if (Number.isFinite(idx) && idx >= 1 && idx <= jobs.slice(0, 20).length) {
        chosenId = jobs[idx - 1].id;
      } else {
        chosenId = trimmed;
      }
      await attachJob(chosenId);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (currentJobId) return;
      detachUi({ clearFile: false });

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) {
        show(extra.error);
        return;
      }
      const maxChunkChars = Number(fd.get('max_chunk_chars') || 0);
      if (!Number.isFinite(maxChunkChars) || maxChunkChars < 200 || maxChunkChars > 4000) {
        show('分片大小（字符数）必须在 200-4000 之间。');
        return;
      }
      show('已提交，准备校验…');

      const file = fd.get('file');
      if (!(file instanceof File)) {
        show('请选择 TXT 文件。');
        return;
      }
      const opts = buildJobOptions(fd, extra.value);
      const requestFd = new FormData();
      requestFd.append('file', file);
      requestFd.append('options', JSON.stringify(opts));

      const res = await fetch('api/v1/jobs', { method: 'POST', body: requestFd });
      const data = await res.json();
      if (!res.ok) {
        show(data);
        return;
      }

      const jobId = data?.job?.id;
      await attachJob(jobId);
    });

    // Auto reattach on page reload.
    try {
      const last = localStorage.getItem(ATTACHED_JOB_KEY);
      if (last) attachJob(last);
    } catch (e) {}

    loadLlmDefaults();
  </script>
</body>
</html>
