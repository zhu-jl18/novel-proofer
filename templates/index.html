<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novel Proofer - 小说打样员</title>
  <link rel="icon" type="image/svg+xml" href="images/logo.svg" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Inter"', '"Noto Sans SC"', 'sans-serif'],
            serif: ['"Noto Serif SC"', 'serif'],
            mono: ['"JetBrains Mono"', '"SF Mono"', 'Consolas', 'monospace'],
          },
          colors: {
            paper: '#FDFBF7',
            ink: '#18181b', // zinc-950
          }
        }
      }
    }
  </script>

  <style>
    /* Custom scrollbar for webkit */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #d4d4d8; }
    
    .tab-btn.active { color: #18181b; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #18181b; }
    
    .filter-btn.active { background-color: #18181b; color: white; border-color: #18181b; }
    
    /* Smooth fade for content */
    .tab-content { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0.95; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

    /* Hide checkbox default and use custom if needed, but standard accent-color is fine for MVP */
    input[type="checkbox"] { accent-color: #18181b; width: 1rem; height: 1rem; cursor: pointer; }
  </style>
</head>
<body class="bg-paper text-slate-800 font-sans antialiased min-h-screen selection:bg-zinc-200 selection:text-ink pb-12">

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-paper mb-5">
        <img src="images/logo.svg" alt="Logo" class="w-12 h-12 opacity-90" />
      </div>
      <h1 class="font-serif text-3xl font-bold tracking-tight text-ink mb-2">Novel Proofer</h1>
      <p class="text-slate-500 font-serif tracking-wide text-sm">优雅的中文小说排版校对工具</p>
    </header>

    <!-- Main Card -->
    <main class="bg-white rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-slate-100 overflow-hidden">
      
      <div class="p-6 sm:p-8 pt-5 sm:pt-6">
        <form id="mainForm" action="#" method="post" enctype="multipart/form-data">
          
          <!-- File Upload Section -->
          <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- 区域1: 文件选择框 -->
              <div class="file-drop group relative p-6 border-2 border-dashed border-slate-200 rounded-xl hover:border-ink/50 hover:bg-slate-50 transition-all duration-200 cursor-pointer text-center" id="fileDrop">
                <div class="pointer-events-none">
                  <div class="mb-2 text-slate-400 group-hover:text-ink transition-colors">
                    <svg class="w-7 h-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <div class="text-sm font-medium text-slate-600 group-hover:text-ink transition-colors" id="fileDropText">点击选择或拖拽 TXT 文件</div>
                </div>
                <input name="file" type="file" accept=".txt,text/plain" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              </div>
              <!-- 区域2: 文件信息显示 -->
              <div class="p-6 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 flex flex-col justify-center" id="fileInfoPanel">
                <div class="text-center text-slate-400" id="fileInfoEmpty">
                  <svg class="w-7 h-7 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div class="text-sm" id="fileInfoEmptyText">未选择任何文件</div>
                </div>
                <div class="hidden" id="fileInfoContent">
                  <div class="space-y-3">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <span class="text-xs text-slate-500">文件名</span>
                      <span class="text-sm font-medium text-slate-700 truncate flex-1" id="fileName">-</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                      </svg>
                      <span class="text-xs text-slate-500">字数</span>
                      <span class="text-sm font-medium text-slate-700 font-mono" id="fileWordCount">-</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Workflow Stepper -->
          <div class="mb-4 flex flex-wrap items-center justify-between gap-2 rounded-lg border border-slate-200 bg-white/70 px-3 py-2">
            <div class="flex items-center gap-2 text-xs font-medium text-slate-500" id="workflowStepper" aria-label="Workflow">
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-ink bg-ink text-white" data-wf-step="validate" title="预处理：解码、切片、本地规则粗处理（不调用 LLM）">预处理</span>
              <span class="text-slate-300">→</span>
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-slate-200 bg-white text-slate-500" data-wf-step="process" title="LLM 校对：逐分片调用 LLM + 输出校验 + 自动重试">LLM校对</span>
              <span class="text-slate-300">→</span>
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-slate-200 bg-white text-slate-500" data-wf-step="merge" title="合并：将各分片输出合并为最终文件（可选清理中间产物）">合并</span>
              <span class="text-slate-300">→</span>
              <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium border-slate-200 bg-white text-slate-500" data-wf-step="done" title="完成：输出文件已生成，可下载/新任务">完成</span>
            </div>
            <span id="wfStateBadge" class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-mono border border-slate-200 bg-slate-100 text-slate-600">未开始</span>
          </div>

          <!-- Action Buttons -->
          <div class="grid gap-3 mb-5">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="actionPrimary">
              <button type="button" id="btnValidate" class="w-full px-5 py-2.5 bg-ink hover:bg-zinc-800 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]">
                开始预处理
              </button>
              <button type="button" id="btnProcess" class="w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                开始校对
              </button>
              <button type="button" id="btnMerge" class="w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                合并输出
              </button>
              <button type="button" id="btnDownload" class="w-full px-5 py-2.5 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-50 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                下载输出
              </button>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3" id="actionControls">
              <button type="button" id="btnPause" class="w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                暂停
              </button>
              <button type="button" id="btnRetry" class="w-full px-5 py-2.5 bg-white border border-amber-200 text-amber-700 hover:bg-amber-50 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                重试失败部分
              </button>
              <button type="button" id="btnCancel" class="w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                新任务
              </button>
              <button type="button" id="btnReset" class="w-full px-5 py-2.5 bg-white border border-red-200 text-red-700 hover:bg-red-50 text-sm font-medium rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                删除任务
              </button>
              <button type="button" id="btnLoad" class="w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm font-medium rounded-lg transition-colors">
                加载任务
              </button>
            </div>
          </div>

          <div class="pt-0 mb-8 flex flex-wrap items-center justify-between gap-3">
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" name="cleanup_debug_dir" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
              <span class="text-xs text-slate-500">合并后清理中间产物（output/.jobs）</span>
              <input type="hidden" name="cleanup_debug_dir" value="0">
            </label>
            <div class="text-[10px] text-slate-300">v2.0</div>
          </div>

          <!-- Progress Card -->
          <div class="mb-8 hidden rounded-xl border border-slate-200 bg-slate-50 p-4" id="progress">
            <div class="flex items-start justify-between gap-4 mb-2">
              <div class="min-w-0 flex-1">
                <div class="text-sm font-medium text-slate-700" id="metaLeft">准备中</div>
                <div class="mt-1 text-xs text-slate-400 truncate hidden" id="metaModelWrap">
                  <span class="text-slate-400">模型</span>
                  <span id="metaModel" class="font-mono">-</span>
                </div>
              </div>
              <div class="text-right flex-shrink-0">
                <div class="text-lg font-bold font-mono text-slate-700" id="metaCounter">0/0</div>
                <div class="text-xs text-slate-400 font-mono hidden" id="metaPctWrap"><span id="metaPct">0</span>%</div>
              </div>
            </div>
            <div class="h-2.5 w-full bg-slate-200 rounded-full overflow-hidden">
              <div class="h-full bg-ink transition-all duration-300 ease-out rounded-full" style="width: 0%" id="bar"></div>
            </div>
          </div>

          <!-- Output Message Area -->
          <div class="mb-8 hidden" id="out">
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
              <pre id="outText" class="text-xs font-mono text-slate-600 whitespace-pre-wrap break-all"></pre>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="flex gap-6 border-b border-slate-100 mb-6 overflow-x-auto pb-1">
            <button type="button" class="tab-btn active pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="progress">进度</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="slice">切片设置</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="llm">LLM 设置</button>
            <button type="button" class="tab-btn pb-3 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors relative whitespace-nowrap" data-tab="debug">调试信息</button>
          </div>

          <!-- Tab: Progress -->
          <div id="tab-progress" class="tab-content block">
            <div class="grid gap-6">
              <div class="bg-slate-50 border border-slate-100 rounded-xl p-4">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">当前任务</div>
                  <div class="text-xs font-mono text-slate-400 text-right break-all select-all" id="jobId">-</div>
                </div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-600">
                  <div class="min-w-0">
                    <span class="text-slate-400">输入：</span><span class="truncate" id="jobInputName">-</span>
                  </div>
                  <div class="min-w-0">
                    <span class="text-slate-400">输出：</span><a class="truncate text-slate-600" id="jobOutputName">-</a>
                  </div>
                </div>
                <div class="mt-2 text-[11px] text-slate-400 font-mono truncate hidden" id="jobOutputPath"></div>
              </div>

              <!-- Stats -->
              <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100" id="statsBar">
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Total</div>
                  <div class="font-mono font-bold text-lg text-slate-700" id="statTotal">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Done</div>
                  <div class="font-mono font-bold text-lg text-green-600" id="statDone">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Active</div>
                  <div class="font-mono font-bold text-lg text-blue-600" id="statProcessing">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Pending</div>
                  <div class="font-mono font-bold text-lg text-slate-500" id="statPending">0</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-slate-400 mb-1">Error</div>
                  <div class="font-mono font-bold text-lg text-red-500" id="statError">0</div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Progress Tab -->

          <!-- Tab: Slice Settings -->
          <div id="tab-slice" class="tab-content hidden">

            <div class="grid gap-8">
              <div class="text-xs text-slate-400 hidden" id="sliceLockHint"></div>

              <!-- Formatting Section -->
              <div>
                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">格式化选项</label>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="paragraph_indent" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">段首统一缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="indent_with_fullwidth_space" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">全角空格缩进</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_blank_lines" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">过多空行压缩</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="trim_trailing_spaces" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">去除行尾空格</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_ellipsis" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范省略号 ……</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_em_dash" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">规范破折号 ——</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_cjk_punctuation" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">中英标点统一</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="fix_cjk_punct_spacing" value="1" checked class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">修正标点间距</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:bg-slate-50 transition-colors cursor-pointer group">
                    <input type="checkbox" name="normalize_quotes" value="1" class="rounded border-slate-300 text-ink focus:ring-ink/20">
                    <span class="text-sm text-slate-700 group-hover:text-ink">引号统一（慎用）</span>
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                   <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出后缀</label>
                    <input name="suffix" type="text" value="_rev" placeholder="_rev" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">分片大小 (200-4000)</label>
                    <input name="max_chunk_chars" type="number" min="200" max="4000" step="100" value="2000" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">输出预览</label>
                    <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono text-slate-400 truncate select-all" id="outputPreview">output/&lt;job_id&gt;_input_rev.txt</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
          <!-- End Slice Settings Tab -->

          <!-- Tab: LLM Settings -->
          <div id="tab-llm" class="tab-content hidden">

            <div class="grid gap-6">
              <div class="text-xs text-slate-400 hidden" id="llmLockHint"></div>

              <div>
                <div class="flex items-center justify-between mb-4">
                  <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">LLM 配置（用于处理/重试）</label>
                  <div class="flex items-center gap-2">
                    <button type="button" class="text-xs text-ink hover:underline font-medium" id="btnSaveLlmDefaults">保存为默认</button>
                    <span id="llmDirtyHint" class="text-[10px] text-amber-500 font-bold hidden">● 未保存</span>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Base URL</label>
                    <input name="llm_base_url" type="text" placeholder="https://api.openai.com/v1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Model Name</label>
                    <input name="llm_model" type="text" placeholder="zai-glm-4.6 / gemini-2.5-pro / minimax-m2.1" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">API Key</label>
                    <div class="relative">
                      <input name="llm_api_key" type="password" placeholder="sk-..." class="w-full pl-3 pr-12 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                      <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 hover:text-ink px-1.5 py-0.5" id="btnToggleApiKey">SHOW</button>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Temp</label>
                    <input name="llm_temperature" type="number" step="0.1" value="0" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">Timeout (秒)</label>
                    <input name="llm_timeout_seconds" type="number" step="1" value="180" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1.5">并发</label>
                    <input name="llm_max_concurrency" type="number" min="1" step="1" value="20" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow">
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-slate-500 mb-1.5">额外参数 (JSON)</label>
                  <textarea name="llm_extra_params" placeholder='{"max_tokens": 4096}' class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono h-20 resize-y focus:outline-none focus:border-ink focus:ring-1 focus:ring-ink/10 transition-shadow"></textarea>
                </div>
              </div>
            </div>
          </div>
          <!-- End LLM Settings Tab -->

          <!-- Tab: Debug -->
          <div id="tab-debug" class="tab-content hidden">

            <!-- Filter -->
             <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button type="button" class="filter-btn active px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="all">全部</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="error">错误</button>
               <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="active">处理中</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="pending">待处理</button>
                <button type="button" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap" data-filter="done">完成</button>
             </div>

            <!-- Table -->
            <div class="border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm" id="chunksTableWrap">
               <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-left text-xs table-fixed">
                  <thead class="bg-slate-50 text-slate-500 font-medium sticky top-0 z-10 shadow-sm border-b border-slate-200">
                    <tr>
                      <th class="py-3 px-2 w-12 text-center font-semibold text-slate-600">#</th>
                      <th class="py-3 px-2 w-16 text-center font-semibold text-slate-600">状态</th>
                      <th class="py-3 px-2 w-40 text-center font-semibold text-slate-600">LLM 模型</th>
                      <th class="py-3 px-2 w-12 text-center font-semibold text-slate-600">重试</th>
                      <th class="py-3 px-2 w-28 text-center font-semibold text-slate-600">In/Out</th>
                      <th class="py-3 px-2 text-center font-semibold text-slate-600">信息</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100 bg-white" id="chunksBody">
                    <!-- JS rendered -->
                  </tbody>
                </table>
               </div>
            </div>
            
            <div id="noChunksHint" class="text-center py-12 text-slate-400 text-sm hidden">
              暂无分片数据，请先开始校对任务。
            </div>

          </div>
          <!-- End Debug Tab -->

        </form>
      </div>
    </main>

    <div class="mt-8 text-center">
       <div class="inline-block px-4 py-2 rounded-full bg-white border border-slate-100 shadow-sm text-xs text-slate-400">
         Powered by LLM & Heuristic Rules
       </div>
    </div>
    
  </div>

  <!-- Custom Modal -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-50 hidden items-center justify-center transition-opacity duration-200">
    <div id="modalBox" class="bg-white rounded-xl shadow-md max-w-xl w-full mx-4 transform transition-all duration-200 scale-95 opacity-0 border border-slate-200/60">
      <div class="px-5 py-4">
        <h3 id="modalTitle" class="text-base font-medium text-slate-800 mb-3">标题</h3>
        <div id="modalBody" class="text-sm text-slate-600 mb-5">内容</div>
        <div id="modalActions" class="flex justify-end gap-3"></div>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const form = document.getElementById('mainForm');
    const out = document.getElementById('out');
    const outText = document.getElementById('outText');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const meta = document.getElementById('meta');
    const metaLeft = document.getElementById('metaLeft');
    const metaCounter = document.getElementById('metaCounter');
    const metaPctWrap = document.getElementById('metaPctWrap');
    const metaPct = document.getElementById('metaPct');
    const metaModelWrap = document.getElementById('metaModelWrap');
    const metaModel = document.getElementById('metaModel');
    const wfStateBadge = document.getElementById('wfStateBadge');
    const btnValidate = document.getElementById('btnValidate');
    const btnProcess = document.getElementById('btnProcess');
    const btnMerge = document.getElementById('btnMerge');
    const btnPause = document.getElementById('btnPause');
    const btnRetry = document.getElementById('btnRetry');
    const btnCancel = document.getElementById('btnCancel');
    const btnReset = document.getElementById('btnReset');
    const btnDownload = document.getElementById('btnDownload');
    const btnLoad = document.getElementById('btnLoad');
    const btnSaveLlmDefaults = document.getElementById('btnSaveLlmDefaults');
    const llmDirtyHint = document.getElementById('llmDirtyHint');
    const btnToggleApiKey = document.getElementById('btnToggleApiKey');
    const fileInput = form.querySelector('input[name="file"]');
    const suffixInput = form.querySelector('input[name="suffix"]');
    const outputPreview = document.getElementById('outputPreview');
    const fileDrop = document.getElementById('fileDrop');
    const fileDropText = document.getElementById('fileDropText');
    const fileName = document.getElementById('fileName');
    const fileInfoPanel = document.getElementById('fileInfoPanel');
    const fileInfoEmpty = document.getElementById('fileInfoEmpty');
    const fileInfoEmptyText = document.getElementById('fileInfoEmptyText');
    const fileInfoContent = document.getElementById('fileInfoContent');
    const fileWordCount = document.getElementById('fileWordCount');
    const jobId = document.getElementById('jobId');
    const jobInputName = document.getElementById('jobInputName');
    const jobOutputName = document.getElementById('jobOutputName');
    const jobOutputPath = document.getElementById('jobOutputPath');
    const sliceLockHint = document.getElementById('sliceLockHint');
    const llmLockHint = document.getElementById('llmLockHint');

    // Debug tab elements
    const chunksBody = document.getElementById('chunksBody');
    const noChunksHint = document.getElementById('noChunksHint');
    const chunksTableWrap = document.getElementById('chunksTableWrap');
    const statTotal = document.getElementById('statTotal');
    const statDone = document.getElementById('statDone');
    const statProcessing = document.getElementById('statProcessing');
    const statPending = document.getElementById('statPending');
    const statError = document.getElementById('statError');

    let currentJobId = null;
    let currentJobState = null;
    let currentJobPhase = null;
    let currentFilter = 'all';
    let activeTab = 'progress';
    let forceChunksFetch = false;
    let chunksData = [];
    let chunkCounts = null;
    let totalChunksFromServer = 0;
    let chunksFetchInFlight = false;

    const UI_STATE_KEY = 'novel_proofer.ui_state.v1';
    const UI_STATE_FIELDS = [
      'suffix',
      'max_chunk_chars',
      'paragraph_indent',
      'indent_with_fullwidth_space',
      'normalize_blank_lines',
      'trim_trailing_spaces',
      'normalize_ellipsis',
      'normalize_em_dash',
      'normalize_cjk_punctuation',
      'fix_cjk_punct_spacing',
      'normalize_quotes',
      'cleanup_debug_dir',
    ];

    function _uiStateElement(name) {
      if (name === 'cleanup_debug_dir') {
        return form.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]');
      }
      return form.querySelector(`[name="${name}"]`);
    }

    function loadUiState() {
      try {
        const raw = localStorage.getItem(UI_STATE_KEY);
        if (!raw) return;
        const state = JSON.parse(raw);
        if (!state || typeof state !== 'object') return;
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          if (el.type === 'checkbox') {
            el.checked = !!state[name];
          } else if (state[name] != null) {
            el.value = String(state[name]);
          }
        }
      } catch (e) {}
    }

    function saveUiState() {
      try {
        const state = {};
        for (const name of UI_STATE_FIELDS) {
          const el = _uiStateElement(name);
          if (!el) continue;
          state[name] = (el.type === 'checkbox') ? !!el.checked : String(el.value || '');
        }
        localStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
      } catch (e) {}
    }

    function _previewOutputPath() {
      const file = fileInput?.files?.[0];
      const rawName = String(file?.name || 'input.txt');
      const name = rawName.split(/[\\/]/).pop() || 'input.txt';
      const dot = name.lastIndexOf('.');
      const stem = (dot > 0) ? name.slice(0, dot) : name;
      const ext = (dot > 0) ? name.slice(dot) : '.txt';
      const suffix = String(suffixInput?.value || '_rev').trim() || '_rev';
      return `output/<job_id>_${stem}${suffix}${ext}`;
    }

    function refreshOutputPreview() {
      if (!outputPreview) return;
      outputPreview.textContent = _previewOutputPath();
    }

    function _countNonWhitespaceChars(text) {
      return String(text || '').replace(/\s/g, '').length;
    }

    const _inputCharsCache = new Map();
    const _inputCharsInFlight = new Set();

    async function ensureJobInputChars(jobId) {
      const jid = String(jobId || '').trim();
      if (!jid) return;
      if (_inputCharsCache.has(jid)) return;
      if (_inputCharsInFlight.has(jid)) return;
      _inputCharsInFlight.add(jid);
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jid)}/input-stats`);
        const data = await res.json().catch(() => null);
        if (!res.ok) return;
        const n = Number(data?.input_chars || 0);
        if (!Number.isFinite(n) || n < 0) return;
        _inputCharsCache.set(jid, Math.floor(n));
        if (currentJobId === jid && fileWordCount) {
          fileWordCount.textContent = Math.floor(n).toLocaleString();
        }
      } catch (e) {
      } finally {
        _inputCharsInFlight.delete(jid);
      }
    }

    function refreshFileName() {
      const file = fileInput?.files?.[0];
      if (file) {
        if (fileName) fileName.textContent = file.name;
        if (fileInfoEmpty) fileInfoEmpty.classList.add('hidden');
        if (fileInfoContent) fileInfoContent.classList.remove('hidden');
        if (fileWordCount) fileWordCount.textContent = '读取中...';
        file.text().then(text => {
          const count = _countNonWhitespaceChars(text);
          if (fileWordCount) fileWordCount.textContent = count.toLocaleString();
        }).catch(() => {
          if (fileWordCount) fileWordCount.textContent = '读取失败';
        });
      } else {
        if (fileName) fileName.textContent = '-';
        if (fileInfoEmpty) fileInfoEmpty.classList.remove('hidden');
        if (fileInfoContent) fileInfoContent.classList.add('hidden');
        if (fileWordCount) fileWordCount.textContent = '-';
      }
      refreshOutputPreview();
    }

    function refreshSourcePanelFromJob(job) {
      const hasJob = !!job?.id;
      if (fileInput) fileInput.disabled = hasJob;
      if (fileDrop) {
        fileDrop.classList.toggle('cursor-pointer', !hasJob);
        fileDrop.classList.toggle('cursor-not-allowed', hasJob);
        fileDrop.classList.toggle('opacity-60', hasJob);
        fileDrop.classList.toggle('hover:border-ink/50', !hasJob);
        fileDrop.classList.toggle('hover:bg-slate-50', !hasJob);
      }

      if (hasJob) {
        if (fileDropText) fileDropText.textContent = '已加载任务（输入已缓存）';
        if (fileInfoEmptyText) fileInfoEmptyText.textContent = '已加载任务（无需重新选择文件）';
        if (fileName) fileName.textContent = String(job?.input_filename || '-');
        const jid = String(job?.id || '').trim();
        const cached = jid ? _inputCharsCache.get(jid) : null;
        if (fileWordCount) fileWordCount.textContent = (typeof cached === 'number') ? cached.toLocaleString() : '读取中...';
        if (fileInfoEmpty) fileInfoEmpty.classList.add('hidden');
        if (fileInfoContent) fileInfoContent.classList.remove('hidden');
        if (jid && cached == null) ensureJobInputChars(jid);
        return;
      }

      if (fileDropText) fileDropText.textContent = '点击选择或拖拽 TXT 文件';
      if (fileInfoEmptyText) fileInfoEmptyText.textContent = '未选择任何文件';
      refreshFileName();
    }

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
      activeTab = tabName;
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-600', btn.dataset.tab === tabName);
        btn.classList.toggle('text-slate-400', btn.dataset.tab !== tabName);
      });
      tabContents.forEach(content => {
          if (content.id === 'tab-' + tabName) {
              content.classList.remove('hidden');
              content.classList.add('block');
          } else {
              content.classList.add('hidden');
              content.classList.remove('block');
          }
      });
      
      localStorage.setItem('activeTab', tabName);
      if (tabName === 'debug' && currentJobId) {
        forceChunksFetch = true;
        refreshChunksNow(currentJobId);
      }
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Restore tab from localStorage
    const savedTab = localStorage.getItem('activeTab');
    switchTab(savedTab || 'progress');

    loadUiState();
    refreshFileName();
    UI_STATE_FIELDS.forEach((name) => {
      const el = _uiStateElement(name);
      if (!el) return;
      el.addEventListener('input', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
      el.addEventListener('change', () => {
        saveUiState();
        if (name === 'suffix') refreshOutputPreview();
      });
    });
    fileInput?.addEventListener('change', refreshFileName);
    if (fileInput && fileDrop) {
      const addDrag = () => {
          fileDrop.classList.add('border-ink', 'bg-slate-50');
      };
      const rmDrag = () => {
          fileDrop.classList.remove('border-ink', 'bg-slate-50');
      };
      fileInput.addEventListener('dragenter', addDrag);
      fileInput.addEventListener('dragleave', rmDrag);
      fileInput.addEventListener('drop', () => {
        rmDrag();
        // Let the browser populate input.files, then refresh UI.
        setTimeout(refreshFileName, 0);
      });
    }

    // Filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        filterBtns.forEach(b => b.classList.toggle('active', b === btn));
        if (activeTab === 'debug' && currentJobId) {
          forceChunksFetch = true;
          refreshChunksNow(currentJobId);
        } else {
          renderChunksTable();
        }
      });
    });

    function getStatusBadge(state) {
      const config = {
          pending: { class: 'bg-slate-100 text-slate-500', label: '待处理' },
          processing: { class: 'bg-blue-50 text-blue-600', label: '处理中' },
          done: { class: 'bg-green-50 text-green-600', label: '完成' },
          error: { class: 'bg-red-50 text-red-600', label: '错误' },
          // retrying is a subset of "processing" (backoff + next attempt), keep state but merge display.
          retrying: { class: 'bg-amber-50 text-amber-600', label: '处理中' }
      };
      
      const c = config[state] || config.pending;
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${c.class}">${c.label}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncateStr(s, maxLen) {
      const str = String(s || '');
      const n = Number(maxLen || 0);
      if (!Number.isFinite(n) || n <= 0) return str;
      if (str.length <= n) return str;
      return str.slice(0, n) + '…';
    }

    function tryParseJson(s) {
      try {
        return JSON.parse(s);
      } catch (e) {
        return null;
      }
    }

    function formatErrorDisplay(code, message) {
      const codeStr = (code == null || code === '') ? '' : String(code);
      const msg = (message == null) ? '' : String(message).trim();

      if (!codeStr && !msg) return null;

      const httpMatch = msg.match(/^HTTP\s+(\d+)\s+from\s+LLM:\s*(.*)$/i);
      if (httpMatch) {
        const httpCode = httpMatch[1] || codeStr || '';
        const body = String(httpMatch[2] || '').trim();

        let reason = '';
        if (body) {
          const parsed = (body.startsWith('{') || body.startsWith('[')) ? tryParseJson(body) : null;
          if (parsed && parsed.error && parsed.error.message) reason = String(parsed.error.message);
          else if (parsed && parsed.message) reason = String(parsed.message);
          else reason = body;
        }

        const brief = httpCode ? `HTTP ${httpCode}` : 'HTTP error';
        const detail = reason ? `${brief}: ${reason}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      if (/LLM output empty/i.test(msg)) {
        return { brief: 'LLM output empty', detail: 'LLM output empty' };
      }

      if (/LLM output too short/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too short (ratio=${m[1]})` : 'LLM output too short';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (/LLM output too long/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too long (ratio=${m[1]})` : 'LLM output too long';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (codeStr) {
        const brief = `HTTP ${codeStr}`;
        const detail = msg ? `${brief}: ${msg}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      const brief = truncateStr(msg, 60);
      return { brief, detail: truncateStr(msg, 300) };
    }

    function renderChunksTable() {
      if (!chunksData || chunksData.length === 0) {
        noChunksHint.classList.remove('hidden');
        chunksTableWrap.classList.add('hidden');
        if (currentJobId) {
          if (currentFilter === 'all') {
            noChunksHint.textContent = '暂无分片数据（可切换到调试信息页以加载）。';
          } else {
            noChunksHint.textContent = '当前过滤条件下无匹配分片。';
          }
        } else {
          noChunksHint.textContent = '暂无分片数据，请先开始校对任务。';
        }
        return;
      }

      noChunksHint.classList.add('hidden');
      chunksTableWrap.classList.remove('hidden');

       const rows = chunksData.slice(0, 500).map(c => {
         let inOut = '-';
         if (c.input_chars != null && c.output_chars != null) inOut = `${c.input_chars} / ${c.output_chars}`;
         else if (c.input_chars != null) inOut = `${c.input_chars} / -`;

          const llmFull = (c.llm_model != null) ? String(c.llm_model) : '';
          // CSS truncation for LLM model
          const llmCell = llmFull
            ? `<div class="truncate max-w-[9rem] mx-auto text-slate-600 font-medium" title="${escapeHtml(llmFull)}">${escapeHtml(llmFull)}</div>`
            : `<span class="text-slate-300">-</span>`;

           const errCode = (c.last_error_code != null) ? String(c.last_error_code) : '';
           const errFull = c.last_error_message ? String(c.last_error_message) : '';
           const err = formatErrorDisplay(errCode, errFull);
           let errMsg = '-';
           if (err) {
             const detail = escapeHtml(err.detail);
             const brief = escapeHtml(err.brief);
             if (c.state === 'error') {
               errMsg = `<span class="text-red-600 font-medium cursor-help border-b border-dotted border-red-300 hover:text-red-700" title="${detail}">${brief}</span>`;
             } else if (c.state === 'retrying') {
              errMsg = `<span class="text-amber-600 font-medium cursor-help border-b border-dotted border-amber-300 hover:text-amber-700" title="${detail}">${brief}</span>`;
            } else if (c.state === 'done') {
              const retries = Number(c.retries || 0);
              if (retries > 0) {
                errMsg = `<span class="text-slate-400 cursor-help border-b border-dotted border-slate-300 hover:text-slate-600" title="${detail}">曾重试: ${brief}</span>`;
              }
            } else {
              errMsg = `<span class="text-slate-400 cursor-help border-b border-dotted border-slate-300" title="${detail}">${brief}</span>`;
            }
          }

         return `<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
           <td class="py-3 px-2 text-slate-400 font-mono text-center whitespace-nowrap text-[11px]">${c.index}</td>
           <td class="py-3 px-2 text-center whitespace-nowrap">${getStatusBadge(c.state)}</td>
           <td class="py-3 px-2 whitespace-nowrap text-xs text-center">${llmCell}</td>
           <td class="py-3 px-2 text-slate-400 text-center whitespace-nowrap font-mono text-xs">${c.retries || 0}</td>
           <td class="py-3 px-2 text-slate-400 font-mono text-[11px] text-center whitespace-nowrap tracking-tight">${inOut}</td>
           <td class="py-3 px-2 text-slate-600 text-xs text-center">${errMsg}</td>
         </tr>`;
       }).join('');


      chunksBody.innerHTML = rows;
    }

    function updateStats() {
      const counts = chunkCounts || {};
      statTotal.textContent = String(totalChunksFromServer || 0);
      statDone.textContent = String(counts.done || 0);
      statProcessing.textContent = String((counts.processing || 0) + (counts.retrying || 0));
      statPending.textContent = String(counts.pending || 0);
      statError.textContent = String(counts.error || 0);
    }

    function showChunks(data) {
      if (!data || !Array.isArray(data.chunks)) return;

      chunksData = data.chunks;
      chunkCounts = data.chunk_counts || null;
      totalChunksFromServer = Number(data?.job?.progress?.total_chunks || 0);
      updateStats();
      renderChunksTable();
    }

    async function refreshChunksNow(jobId) {
      if (!jobId) return;
      if (chunksFetchInFlight) return;
      chunksFetchInFlight = true;
      try {
        const q = new URLSearchParams({ chunks: '1' });
        q.set('chunk_state', currentFilter);
        q.set('limit', '500');
        q.set('offset', '0');

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        showChunks(data);
      } catch (e) {
        show(String(e));
      } finally {
        chunksFetchInFlight = false;
      }
    }

    function show(obj) {
      out.classList.remove('hidden');
      outText.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    // --- Custom Modal API ---
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalBox = document.getElementById('modalBox');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalActions = document.getElementById('modalActions');
    let modalCloseCallback = null;

    function openModal() {
      modalBackdrop.classList.remove('hidden');
      modalBackdrop.classList.add('flex');
      requestAnimationFrame(() => {
        modalBox.classList.remove('scale-95', 'opacity-0');
        modalBox.classList.add('scale-100', 'opacity-100');
      });
    }

    function closeModal() {
      modalBox.classList.remove('scale-100', 'opacity-100');
      modalBox.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        modalBackdrop.classList.add('hidden');
        modalBackdrop.classList.remove('flex');
        if (modalCloseCallback) { modalCloseCallback(); modalCloseCallback = null; }
      }, 200);
    }

    modalBackdrop?.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) closeModal();
    });

    function showConfirm(message) {
      return new Promise((resolve) => {
        modalTitle.textContent = '确认操作';
        modalBody.innerHTML = `<p class="whitespace-pre-wrap">${message}</p>`;
        modalActions.innerHTML = `
          <button type="button" class="modal-cancel px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">取消</button>
          <button type="button" class="modal-confirm px-4 py-2 bg-ink text-white text-sm font-medium rounded-lg hover:bg-zinc-800 transition-colors">确认</button>
        `;
        modalCloseCallback = () => resolve(false);
        modalActions.querySelector('.modal-cancel').onclick = () => { closeModal(); resolve(false); };
        modalActions.querySelector('.modal-confirm').onclick = () => { closeModal(); resolve(true); };
        openModal();
      });
    }

    function showJobPicker(jobs) {
      return new Promise((resolve) => {
        modalTitle.textContent = '选择要加载的任务';
        const listHtml = jobs.slice(0, 20).map((j, i) => {
          const jobId = escapeHtml(j?.id ? String(j.id) : '');
          const id8 = escapeHtml(j?.id ? String(j.id).slice(0, 8) : '-');
          const st = escapeHtml(j?.state || '-');
          const phase = escapeHtml(j?.phase || '-');
          const prog = escapeHtml(`${j?.progress?.done_chunks || 0}/${j?.progress?.total_chunks || 0}`);
          const name = escapeHtml(j?.input_filename ? String(j.input_filename) : '');
          const stColor = { done: 'bg-emerald-100 text-emerald-700', error: 'bg-red-100 text-red-700', paused: 'bg-amber-100 text-amber-700', cancelled: 'bg-slate-200 text-slate-600' }[j?.state] || 'bg-slate-100 text-slate-600';
          return `<button type="button" data-job-id="${jobId}" class="job-item w-full text-left px-3 py-2 rounded-lg hover:bg-slate-50 border border-slate-100 hover:border-slate-200 transition-colors flex items-center gap-3">
            <span class="font-mono text-xs text-slate-400">${id8}</span>
            <span class="text-xs px-1.5 py-0.5 rounded ${stColor}">${st}:${phase}</span>
            <span class="text-xs text-slate-500 font-mono">${prog}</span>
            <span class="text-sm text-slate-700 truncate flex-1">${name}</span>
          </button>`;
        }).join('');
        modalBody.innerHTML = `
          <div class="space-y-2 max-h-64 overflow-y-auto mb-4">${listHtml || '<p class="text-slate-400 text-sm">暂无可加载任务</p>'}</div>
          <div class="flex items-center gap-2 pt-3 border-t border-slate-100">
            <input type="text" id="manualJobId" placeholder="或输入完整 job_id" class="flex-1 px-3 py-1.5 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ink/20 focus:border-ink font-mono" />
            <button type="button" class="modal-manual px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-ink transition-colors">加载</button>
          </div>
        `;
        modalActions.innerHTML = `<button type="button" class="modal-cancel px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">取消</button>`;
        modalCloseCallback = () => resolve(null);
        modalActions.querySelector('.modal-cancel').onclick = () => { closeModal(); resolve(null); };
        modalBody.querySelectorAll('.job-item').forEach(btn => {
          btn.onclick = () => { closeModal(); resolve(btn.dataset.jobId); };
        });
        modalBody.querySelector('.modal-manual').onclick = () => {
          const val = modalBody.querySelector('#manualJobId').value.trim();
          if (val) { closeModal(); resolve(val); }
        };
        modalBody.querySelector('#manualJobId').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const val = e.target.value.trim();
            if (val) { closeModal(); resolve(val); }
          }
        });
        openModal();
      });
    }
    // --- End Modal API ---

    function _phaseLabel(phase) {
      const v = String(phase || '').toLowerCase();
      const map = { validate: '预处理', process: 'LLM校对', merge: '合并', done: '完成' };
      return map[v] || (v || '-');
    }

    function _stateLabel(state) {
      const v = String(state || '').toLowerCase();
      const map = { queued: '排队中', running: '运行中', paused: '已暂停', done: '已完成', cancelled: '已取消', error: '出错' };
      return map[v] || (v || '-');
    }

    function setJobCard(job) {
      const j = job || null;
      if (jobId) jobId.textContent = j?.id ? String(j.id) : '-';
      if (jobInputName) jobInputName.textContent = j?.input_filename ? String(j.input_filename) : '-';
      if (jobOutputName) {
        const outName = j?.output_filename ? String(j.output_filename) : '-';
        jobOutputName.textContent = outName;
        const isDone = String(j?.state || '').toLowerCase() === 'done' && !!j?.id && !!j?.output_path;
        if (isDone && outName !== '-') {
          jobOutputName.classList.add('text-ink', 'hover:underline');
          jobOutputName.classList.remove('text-slate-600');
          jobOutputName.setAttribute('href', `api/v1/jobs/${encodeURIComponent(j.id)}/download`);
          jobOutputName.setAttribute('download', outName);
        } else {
          jobOutputName.classList.remove('text-ink', 'hover:underline');
          jobOutputName.classList.add('text-slate-600');
          jobOutputName.removeAttribute('href');
          jobOutputName.removeAttribute('download');
        }
      }
      if (jobOutputPath) {
        const hasPath = !!j?.output_path;
        jobOutputPath.textContent = hasPath ? String(j.output_path) : '';
        jobOutputPath.classList.toggle('hidden', !hasPath);
      }
    }

    function setProgressFromJob(job) {
      if (!job) {
        progress.classList.add('hidden');
        if (metaModelWrap) metaModelWrap.classList.add('hidden');
        return;
      }

      progress.classList.remove('hidden');
      const state = String(job.state || '').toLowerCase();
      const phase = String(job.phase || '').toLowerCase();
      const done = Number(job?.progress?.done_chunks || 0);
      const total = Number(job?.progress?.total_chunks || 0);
      const pct = total > 0 ? Math.floor((done / total) * 100) : (state === 'done' ? 100 : 0);
      bar.style.width = pct + '%';

      // Bar color by state
      bar.classList.remove('bg-ink', 'bg-amber-500', 'bg-red-500', 'bg-emerald-500');
      if (state === 'error') bar.classList.add('bg-red-500');
      else if (state === 'paused') bar.classList.add('bg-amber-500');
      else if (state === 'done') bar.classList.add('bg-emerald-500');
      else bar.classList.add('bg-ink');

      let left = _stateLabel(state);
      if (state === 'running' && phase === 'validate') left = '正在预处理…';
      if (state === 'paused' && phase === 'process') left = (done > 0 ? '校对已暂停' : '预处理完成，等待开始校对');
      if (state === 'running' && phase === 'process') left = '正在校对…';
      if (state === 'error' && phase === 'process') left = '校对出错';
      if (state === 'paused' && phase === 'merge') left = '校对完成，等待合并输出';
      if (state === 'running' && phase === 'merge') left = '正在合并输出…';
      if (state === 'done') left = '完成';

      metaLeft.textContent = left;
      if (metaCounter) metaCounter.textContent = `${done}/${total}`;

      // Show pct only when 0 < pct < 100
      const showPct = pct > 0 && pct < 100;
      if (metaPctWrap) metaPctWrap.classList.toggle('hidden', !showPct);
      if (metaPct) metaPct.textContent = String(pct);

      const model = job?.llm_model ? String(job.llm_model).trim() : '';
      if (metaModel) metaModel.textContent = model || '-';
      if (metaModelWrap) metaModelWrap.classList.toggle('hidden', !model);
    }

    function _setVisible(el, visible) {
      if (!el) return;
      el.classList.toggle('hidden', !visible);
    }

    function _setDisabled(el, disabled) {
      if (!el) return;
      el.disabled = !!disabled;
      el.classList.toggle('opacity-50', !!disabled);
      el.classList.toggle('cursor-not-allowed', !!disabled);
    }

    const SLICE_FIELDS = [
      'suffix',
      'max_chunk_chars',
      'paragraph_indent',
      'indent_with_fullwidth_space',
      'normalize_blank_lines',
      'trim_trailing_spaces',
      'normalize_ellipsis',
      'normalize_em_dash',
      'normalize_cjk_punctuation',
      'fix_cjk_punct_spacing',
      'normalize_quotes',
    ];

    const LLM_FIELDS = [
      'llm_base_url',
      'llm_model',
      'llm_api_key',
      'llm_temperature',
      'llm_timeout_seconds',
      'llm_max_concurrency',
      'llm_extra_params',
    ];

    function _setFieldsDisabled(names, disabled) {
      for (const name of names) {
        const el = form.querySelector(`[name="${name}"]`);
        if (!el) continue;
        el.disabled = !!disabled;
        el.classList.toggle('opacity-50', !!disabled);
        el.classList.toggle('cursor-not-allowed', !!disabled);
      }
    }

    function refreshLocks(job) {
      const hasJob = !!job;
      const llmLocked = hasJob && ['queued', 'running'].includes(String(job.state || ''));

      _setFieldsDisabled(SLICE_FIELDS, hasJob);
      if (sliceLockHint) {
        sliceLockHint.classList.toggle('hidden', !hasJob);
        if (hasJob) sliceLockHint.textContent = '当前已关联任务，切片设置已锁定（要修改请先点“新任务”解除关联，或删除任务后重新创建）。';
      }

      _setFieldsDisabled(LLM_FIELDS, llmLocked);
      if (llmLockHint) {
        llmLockHint.classList.toggle('hidden', !llmLocked);
        if (llmLocked) llmLockHint.textContent = '任务运行中，LLM 配置已锁定（暂停/出错后可修改并用于继续/重试）。';
      }
    }

    function refreshWorkflowStepper(job) {
      const state = String(job?.state || '').toLowerCase();
      const phase = String(job?.phase || '').toLowerCase();
      const hasJob = !!job;

      const order = ['validate', 'process', 'merge', 'done'];
      let cur = hasJob ? phase : 'validate';
      if (!order.includes(cur)) cur = 'validate';
      if (state === 'done') cur = 'done';

      const curIdx = order.indexOf(cur);

      const base = 'inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium cursor-help';
      const clsIdle = 'border-slate-200 bg-white text-slate-500';
      const clsDone = 'border-slate-200 bg-slate-100 text-slate-500';
      const clsActive = 'border-ink bg-ink text-white';
      const clsError = 'border-red-200 bg-red-50 text-red-700';

      document.querySelectorAll('[data-wf-step]').forEach((el) => {
        const step = String(el.getAttribute('data-wf-step') || '').toLowerCase();
        const idx = order.indexOf(step);
        let variant = clsIdle;
        if (idx >= 0 && idx < curIdx) variant = clsDone;
        if (idx === curIdx) variant = (hasJob && state === 'error') ? clsError : clsActive;
        el.className = `${base} ${variant}`;
      });

      if (wfStateBadge) {
        const badgeBase = 'inline-flex items-center rounded-full px-2 py-0.5 text-xs font-mono border';
        let badgeText = '未开始';
        let badgeVariant = 'border-slate-200 bg-slate-100 text-slate-600';
        if (hasJob) {
          badgeText = _stateLabel(state);
          if (state === 'paused') badgeVariant = 'border-amber-200 bg-amber-50 text-amber-700';
          else if (state === 'error') badgeVariant = 'border-red-200 bg-red-50 text-red-700';
          else if (state === 'done') badgeVariant = 'border-emerald-200 bg-emerald-50 text-emerald-700';
        }
        wfStateBadge.textContent = badgeText;
        wfStateBadge.className = `${badgeBase} ${badgeVariant}`;
      }
    }

    function refreshActionButtons(job) {
      const state = String(job?.state || '').toLowerCase();
      const phase = String(job?.phase || '').toLowerCase();
      const hasJob = !!job;

      const BTN_SOLID_INK = 'w-full px-5 py-2.5 bg-ink hover:bg-zinc-800 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]';
      const BTN_OUTLINE = 'w-full px-5 py-2.5 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 text-sm font-medium rounded-lg transition-colors';
      const BTN_SOLID_EMERALD = 'w-full px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]';
      const BTN_OUTLINE_EMERALD = 'w-full px-5 py-2.5 bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-50 text-sm font-medium rounded-lg transition-colors';
      const BTN_SOLID_AMBER = 'w-full px-5 py-2.5 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg shadow-sm hover:shadow transition-all active:scale-[0.98]';
      const BTN_OUTLINE_AMBER = 'w-full px-5 py-2.5 bg-white border border-amber-200 text-amber-700 hover:bg-amber-50 text-sm font-medium rounded-lg transition-colors';
      const BTN_OUTLINE_RED = 'w-full px-5 py-2.5 bg-white border border-red-200 text-red-700 hover:bg-red-50 text-sm font-medium rounded-lg transition-colors';

      // Validate: start new job OR resume validate if paused in validate phase.
      const canResumeValidate = hasJob && state === 'paused' && phase === 'validate';
      const canValidate = (!hasJob) || canResumeValidate;
      if (btnValidate) btnValidate.textContent = canResumeValidate ? '继续预处理' : '开始预处理';

      const canProcess = hasJob && state === 'paused' && phase === 'process';
      if (btnProcess) {
        const done = Number(job?.progress?.done_chunks || 0);
        btnProcess.textContent = (hasJob && phase === 'process' && done > 0) ? '继续校对' : '开始校对';
      }

      const canMerge = hasJob && state === 'paused' && phase === 'merge';

      const canPause = hasJob && (state === 'queued' || state === 'running') && phase === 'process';

      const canRetry = hasJob && state === 'error';

      const canNewTask = hasJob && !((state === 'queued' || state === 'running') && phase === 'process');

      const canDeleteTask = hasJob && !((state === 'queued' || state === 'running') && phase === 'process');

      if (btnCancel) {
        btnCancel.textContent = '新任务';
      }

      if (btnReset) {
        btnReset.textContent = (hasJob && state === 'done') ? '删除任务记录' : '删除任务';
      }

      const canDownload = hasJob && state === 'done';

      let primaryKey = null;
      if (!hasJob || (state === 'paused' && phase === 'validate')) primaryKey = 'validate';
      else if (state === 'paused' && phase === 'process') primaryKey = 'process';
      else if (state === 'paused' && phase === 'merge') primaryKey = 'merge';
      else if (state === 'done') primaryKey = 'download';
      else if ((state === 'queued' || state === 'running') && phase === 'process') primaryKey = 'pause';
      else if (state === 'error') primaryKey = 'retry';

      if (btnValidate) btnValidate.className = (primaryKey === 'validate') ? BTN_SOLID_INK : BTN_OUTLINE;
      if (btnProcess) btnProcess.className = (primaryKey === 'process') ? BTN_SOLID_INK : BTN_OUTLINE;
      if (btnMerge) btnMerge.className = (primaryKey === 'merge') ? BTN_SOLID_INK : BTN_OUTLINE;
      if (btnDownload) btnDownload.className = (primaryKey === 'download') ? BTN_SOLID_EMERALD : BTN_OUTLINE_EMERALD;
      if (btnPause) btnPause.className = (primaryKey === 'pause') ? BTN_SOLID_INK : BTN_OUTLINE;
      if (btnRetry) btnRetry.className = (primaryKey === 'retry') ? BTN_SOLID_AMBER : BTN_OUTLINE_AMBER;
      if (btnCancel) btnCancel.className = BTN_OUTLINE;
      if (btnReset) btnReset.className = BTN_OUTLINE_RED;
      if (btnLoad) btnLoad.className = BTN_OUTLINE;

      _setDisabled(btnValidate, !canValidate);
      _setDisabled(btnProcess, !canProcess);
      _setDisabled(btnMerge, !canMerge);
      _setDisabled(btnPause, !canPause);
      _setDisabled(btnRetry, !canRetry);
      _setDisabled(btnCancel, !canNewTask);
      _setDisabled(btnReset, !canDeleteTask);
      _setDisabled(btnDownload, !canDownload);
      _setDisabled(btnLoad, false);

      refreshWorkflowStepper(job);
    }

    function _llmSnapshot() {
      const fd = new FormData(form);
      return JSON.stringify({
        base_url: String(fd.get('llm_base_url') || ''),
        model: String(fd.get('llm_model') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        temperature: String(fd.get('llm_temperature') || ''),
        timeout_seconds: String(fd.get('llm_timeout_seconds') || ''),
        max_concurrency: String(fd.get('llm_max_concurrency') || ''),
        extra_params: String(fd.get('llm_extra_params') || '').trim(),
      });
    }

    let _llmSavedSnapshot = null;

    function _setLlmDirty(dirty) {
      llmDirtyHint.classList.toggle('hidden', !dirty);
      llmDirtyHint.classList.toggle('inline', dirty);
      btnSaveLlmDefaults.disabled = !dirty;
      btnSaveLlmDefaults.classList.toggle('opacity-50', !dirty);
    }

    function _refreshLlmDirty() {
      if (_llmSavedSnapshot == null) return;
      _setLlmDirty(_llmSnapshot() !== _llmSavedSnapshot);
    }

    async function loadLlmDefaults() {
      try {
        const res = await fetch('api/v1/settings/llm');
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        const llm = data?.llm || {};
        const setIfProvided = (name, value) => {
          if (value === undefined || value === null) return;
          const el = form.querySelector(`[name="${name}"]`);
          if (!el) return;
          el.value = String(value);
        };

        setIfProvided('llm_base_url', llm.base_url);
        setIfProvided('llm_model', llm.model);
        setIfProvided('llm_api_key', llm.api_key);
        if (llm.temperature !== undefined && llm.temperature !== null) setIfProvided('llm_temperature', llm.temperature);
        if (llm.timeout_seconds !== undefined && llm.timeout_seconds !== null) setIfProvided('llm_timeout_seconds', llm.timeout_seconds);
        if (llm.max_concurrency !== undefined && llm.max_concurrency !== null) setIfProvided('llm_max_concurrency', llm.max_concurrency);
        if (llm.extra_params !== undefined && llm.extra_params !== null) {
          const el = form.querySelector('[name="llm_extra_params"]');
          if (el) el.value = JSON.stringify(llm.extra_params, null, 2);
        }
      } catch (e) {
        show(String(e));
      } finally {
        _llmSavedSnapshot = _llmSnapshot();
        _setLlmDirty(false);
      }
    }

    async function requestSaveLlmDefaults() {
      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = {
        llm: {
          base_url: String(fd.get('llm_base_url') || ''),
          api_key: String(fd.get('llm_api_key') || ''),
          model: String(fd.get('llm_model') || ''),
          temperature: Number(fd.get('llm_temperature') || 0),
          timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
          max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
          extra_params: extra.value,
        }
      };
      try {
        const res = await fetch('api/v1/settings/llm', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnSaveLlmDefaults.addEventListener('click', async () => {
      btnSaveLlmDefaults.disabled = true;
      const r = await requestSaveLlmDefaults();
      if (!r.ok) {
        show(r.error);
        _refreshLlmDirty();
        return;
      }
      show('默认 LLM 配置已保存。');
      _llmSavedSnapshot = _llmSnapshot();
      _setLlmDirty(false);
    });

    ['llm_base_url', 'llm_model', 'llm_api_key', 'llm_temperature', 'llm_timeout_seconds', 'llm_max_concurrency', 'llm_extra_params'].forEach((name) => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;
      el.addEventListener('input', _refreshLlmDirty);
      el.addEventListener('change', _refreshLlmDirty);
    });

    btnToggleApiKey.addEventListener('click', () => {
      const el = form.querySelector('[name="llm_api_key"]');
      if (!el) return;
      if (el.type === 'password') {
        el.type = 'text';
        btnToggleApiKey.textContent = 'HIDE';
      } else {
        el.type = 'password';
        btnToggleApiKey.textContent = 'SHOW';
      }
    });

    function parseExtraParamsFromFormData(fd) {
      const raw = String(fd.get('llm_extra_params') || '').trim();
      if (!raw) return { ok: true, value: null };
      try {
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) {
          return { ok: false, error: '额外参数必须是 JSON 对象（例如 {"max_tokens": 4096}）。' };
        }
        return { ok: true, value: obj };
      } catch (e) {
        return { ok: false, error: '额外参数 JSON 无效，请检查括号/引号/逗号。' };
      }
    }

    function buildLlmOptions(fd, extraParamsValue) {
      return {
        base_url: String(fd.get('llm_base_url') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        model: String(fd.get('llm_model') || ''),
        temperature: Number(fd.get('llm_temperature') || 0),
        timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
        max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
        extra_params: extraParamsValue,
      };

    }

    function buildJobOptions(fd, extraParamsValue) {
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      return {
        format: {
          max_chunk_chars: Number(fd.get('max_chunk_chars') || 2000),
          paragraph_indent: fd.get('paragraph_indent') != null,
          indent_with_fullwidth_space: fd.get('indent_with_fullwidth_space') != null,
          normalize_blank_lines: fd.get('normalize_blank_lines') != null,
          trim_trailing_spaces: fd.get('trim_trailing_spaces') != null,
          normalize_ellipsis: fd.get('normalize_ellipsis') != null,
          normalize_em_dash: fd.get('normalize_em_dash') != null,
          normalize_cjk_punctuation: fd.get('normalize_cjk_punctuation') != null,
          fix_cjk_punct_spacing: fd.get('fix_cjk_punct_spacing') != null,
          normalize_quotes: fd.get('normalize_quotes') != null,
        },
        llm: buildLlmOptions(fd, extraParamsValue),
        output: {
          suffix: String(fd.get('suffix') || '_rev'),
          cleanup_debug_dir: cleanupDebugDir,
        },
      };
    }

    async function requestCancel(jobId) {
      if (!jobId) return;
      try {
        await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cancel`, { method: 'POST' });
      } catch (e) {}
    }

    async function requestPause(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/pause`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestResume(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestRetryFailed(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/retry-failed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestMerge(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      const payload = { cleanup_debug_dir: cleanupDebugDir };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/merge`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestReset(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/reset`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestJobSummary(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      const q = new URLSearchParams({ chunks: '1', chunk_state: 'all', limit: '1', offset: '0' });
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data, status: res.status };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestJobList() {
      try {
        const res = await fetch('api/v1/jobs?limit=50');
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    const ATTACHED_JOB_KEY = 'novel_proofer.attached_job_id.v2';
    let pollTimer = null;
    let pollJobId = null;
    let pollInFlight = false;

    function stopPolling() {
      if (!pollTimer) return;
      clearInterval(pollTimer);
      pollTimer = null;
      pollJobId = null;
    }

    function ensurePolling(jobId) {
      if (pollTimer && pollJobId === jobId) return;
      stopPolling();
      pollJobId = jobId;
      pollTimer = setInterval(() => refreshJobOnce(jobId), 1000);
    }

    function detachUi({ clearFile = true } = {}) {
      stopPolling();
      pollInFlight = false;

      currentJobId = null;
      currentJobState = null;
      currentJobPhase = null;
      try { localStorage.removeItem(ATTACHED_JOB_KEY); } catch (e) {}

      chunksData = [];
      chunkCounts = null;
      totalChunksFromServer = 0;
      updateStats();
      renderChunksTable();

      setJobCard(null);
      setProgressFromJob(null);
      refreshLocks(null);
      refreshActionButtons(null);
      out.classList.add('hidden');
      outText.textContent = '';

      if (clearFile && fileInput) {
        fileInput.value = '';
      }
      refreshSourcePanelFromJob(null);
    }

    async function refreshJobOnce(jobId) {
      if (!jobId || currentJobId !== jobId) return;
      if (pollInFlight) return;
      pollInFlight = true;
      try {
        const r = await requestJobSummary(jobId);
        if (!jobId || currentJobId !== jobId) return;
        if (!r.ok) {
          // 404 means job removed (e.g., reset finished)
          if (r.status === 404) {
            detachUi();
            show('任务已被清理或不存在。');
            return;
          }
          show(r.error);
          return;
        }

        const job = r?.data?.job;
        currentJobState = job?.state || null;
        currentJobPhase = job?.phase || null;

        // Sync slice settings from job snapshot (do not persist to localStorage).
        const fmt = job?.format || null;
        if (fmt) {
          const setCheck = (name, val) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (el) el.checked = !!val;
          };
          const setNum = (name, val) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (el && val != null) el.value = String(val);
          };
          setNum('max_chunk_chars', fmt.max_chunk_chars);
          setCheck('paragraph_indent', fmt.paragraph_indent);
          setCheck('indent_with_fullwidth_space', fmt.indent_with_fullwidth_space);
          setCheck('normalize_blank_lines', fmt.normalize_blank_lines);
          setCheck('trim_trailing_spaces', fmt.trim_trailing_spaces);
          setCheck('normalize_ellipsis', fmt.normalize_ellipsis);
          setCheck('normalize_em_dash', fmt.normalize_em_dash);
          setCheck('normalize_cjk_punctuation', fmt.normalize_cjk_punctuation);
          setCheck('fix_cjk_punct_spacing', fmt.fix_cjk_punct_spacing);
          setCheck('normalize_quotes', fmt.normalize_quotes);
        }

        setJobCard(job);
        setProgressFromJob(job);
        refreshLocks(job);
        refreshActionButtons(job);
        refreshSourcePanelFromJob(job);

        chunkCounts = r?.data?.chunk_counts || null;
        totalChunksFromServer = Number(job?.progress?.total_chunks || 0);
        updateStats();

        if (job?.state === 'error') {
          show(job?.error || '处理出错');
        } else if (job?.state === 'paused' && job?.phase === 'process') {
          const done = Number(job?.progress?.done_chunks || 0);
          show(done > 0 ? '校对已暂停：可点击“继续校对”。' : '预处理完成：可点击“开始校对”。');
        } else if (job?.state === 'paused' && job?.phase === 'merge') {
          show('校对完成：可点击“合并输出”。');
        } else if (job?.state === 'done') {
          show(job?.output_path ? `完成。输出：${job.output_path}\n可点击“下载输出”或“新任务”。` : '完成。已输出到项目 output/ 目录。');
        }

        const counts = chunkCounts || {};
        const active = Number(counts.processing || 0) + Number(counts.retrying || 0);
        const stLower = String(job?.state || '').toLowerCase();
        const shouldPoll = stLower === 'queued' || stLower === 'running' || (stLower === 'paused' && active > 0);
        if (shouldPoll) ensurePolling(jobId);
        else stopPolling();

        if (activeTab === 'debug') {
          forceChunksFetch = true;
          await refreshChunksNow(jobId);
        }
      } finally {
        pollInFlight = false;
      }
    }

    async function attachJob(jobId) {
      const jid = String(jobId || '').trim();
      if (!jid) return;
      currentJobId = jid;
      try { localStorage.setItem(ATTACHED_JOB_KEY, jid); } catch (e) {}

      // Reset debug view but keep form values (they will be overwritten by job.format when fetched).
      chunksData = [];
      chunkCounts = null;
      totalChunksFromServer = 0;
      updateStats();
      renderChunksTable();

      ensurePolling(jid);
      await refreshJobOnce(jid);
    }

    btnPause?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      _setDisabled(btnPause, true);
      show('正在暂停…');
      const r = await requestPause(jobId);
      if (!r.ok) {
        show(r.error);
        _setDisabled(btnPause, false);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnRetry?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('准备重试失败分片…');
      const r = await requestRetryFailed(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnProcess?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('开始校对…');
      const r = await requestResume(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnMerge?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('开始合并输出…');
      const r = await requestMerge(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      await refreshJobOnce(jobId);
    });

    btnDownload?.addEventListener('click', () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const url = `api/v1/jobs/${encodeURIComponent(jobId)}/download`;
      const a = document.createElement('a');
      a.href = url;
      a.download = '';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnValidate?.addEventListener('click', async () => {
      // Start new validation when idle; resume validate only if paused in validate phase.
      if (!currentJobId) {
        form.requestSubmit();
        return;
      }
      if (currentJobState === 'paused' && currentJobPhase === 'validate') {
        const jobId = currentJobId;
        show('继续预处理…');
        const r = await requestResume(jobId);
        if (!r.ok) {
          show(r.error);
          return;
        }
        await refreshJobOnce(jobId);
      }
    });

    btnCancel?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const st = String(currentJobState || '').toLowerCase();
      const phase = String(currentJobPhase || '').toLowerCase();
      const isRunning = st === 'queued' || st === 'running';
      if (isRunning && phase === 'process') {
        show('校对进行中：请先“暂停”再开始新任务。');
        return;
      }
      detachUi({ clearFile: true });
      show(isRunning
        ? '已切换到新任务。该任务仍在后台运行；可通过“加载任务”重新关联查看状态（进入暂停/完成后再继续下一步/下载）。'
        : '已切换到新任务。可通过“加载任务”返回该任务继续/下载。');
    });

    btnReset?.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const st = String(currentJobState || '').toLowerCase();
      const phase = String(currentJobPhase || '').toLowerCase();
      if ((st === 'queued' || st === 'running') && phase === 'process') {
        show('校对进行中：请先“暂停”再删除任务。');
        return;
      }
      const confirmMsg = (st === 'done')
        ? '确认"删除任务记录"？该任务的中间态/状态记录将被删除且不可恢复（不会删除最终输出文件 output/）。'
        : '确认"删除任务"？该任务将被停止并删除中间产物与状态记录，且不可恢复（不会删除 output/ 下已生成的最终输出文件）。';
      if (!(await showConfirm(confirmMsg))) return;

      show((st === 'done') ? '正在删除任务记录…' : '正在删除任务…');
      const r = await requestReset(jobId);
      if (!r.ok) {
        show(r.error);
        return;
      }
      detachUi({ clearFile: true });
      show('已提交删除请求。');
    });

    btnLoad?.addEventListener('click', async () => {
      const r = await requestJobList();
      if (!r.ok) {
        show(r.error);
        return;
      }
      const jobs = Array.isArray(r?.data?.jobs) ? r.data.jobs : [];
      if (!jobs.length) {
        show('暂无可加载任务。');
        return;
      }

      const chosenId = await showJobPicker(jobs);
      if (!chosenId) return;
      await attachJob(chosenId);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (currentJobId) return;
      detachUi({ clearFile: false });

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) {
        show(extra.error);
        return;
      }
      const maxChunkChars = Number(fd.get('max_chunk_chars') || 0);
      if (!Number.isFinite(maxChunkChars) || maxChunkChars < 200 || maxChunkChars > 4000) {
        show('分片大小（字符数）必须在 200-4000 之间。');
        return;
      }
      show('已提交，准备预处理…');

      const file = fd.get('file');
      if (!(file instanceof File)) {
        show('请选择 TXT 文件。');
        return;
      }
      const opts = buildJobOptions(fd, extra.value);
      const requestFd = new FormData();
      requestFd.append('file', file);
      requestFd.append('options', JSON.stringify(opts));

      const res = await fetch('api/v1/jobs', { method: 'POST', body: requestFd });
      const data = await res.json();
      if (!res.ok) {
        show(data);
        return;
      }

      const jobId = data?.job?.id;
      await attachJob(jobId);
    });

    // Auto reattach on page reload.
    try {
      const last = localStorage.getItem(ATTACHED_JOB_KEY);
      if (last) attachJob(last);
    } catch (e) {}

    loadLlmDefaults();
  </script>
</body>
</html>
