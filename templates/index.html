<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novel Proofer</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z' stroke='%23292D32' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M18.3801 15.27V7.57999C18.3801 6.80999 17.7601 6.25 17.0001 6.31H16.9601C15.6201 6.42 13.5901 7.11001 12.4501 7.82001L12.3401 7.89002C12.1601 8.00002 11.8501 8.00002 11.6601 7.89002L11.5001 7.79001C10.3701 7.08001 8.34012 6.40999 7.00012 6.29999C6.24012 6.23999 5.62012 6.81001 5.62012 7.57001V15.27C5.62012 15.88 6.1201 16.46 6.7301 16.53L6.9101 16.56C8.2901 16.74 10.4301 17.45 11.6501 18.12L11.6801 18.13C11.8501 18.23 12.1301 18.23 12.2901 18.13C13.5101 17.45 15.6601 16.75 17.0501 16.56L17.2601 16.53C17.8801 16.46 18.3801 15.89 18.3801 15.27Z' stroke='%23292D32' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M12 8.1001V17.6601' stroke='%23292D32' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #fafafa;
      --card: #fff;
      --text: #1a1a1a;
      --text-muted: #6b7280;
      --border: #e5e5e5;
      --accent: #18181b;
      --accent-hover: #27272a;
      --input-bg: #f9fafb;
      --shadow: 0 1px 3px rgba(0,0,0,.04), 0 4px 12px rgba(0,0,0,.03);
      --shadow-lg: 0 4px 20px rgba(0,0,0,.06);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans CJK SC", "Microsoft YaHei", sans-serif; margin: 0; padding: 12px 24px 24px; background: var(--bg); color: var(--text); line-height: 1.5; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 1.5rem; font-weight: 600; margin: 0 0 24px; letter-spacing: -0.02em; text-align: center; color: var(--text); }
    .card { background: var(--card); border-radius: var(--radius); padding: 16px 36px 28px; box-shadow: var(--shadow); }

    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    label { display: block; font-size: 13px; color: var(--text-muted); margin: 12px 0 5px; font-weight: 500; }
    input[type="text"], input[type="number"] { width: 180px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--input-bg); font-size: 14px; transition: border-color .15s, box-shadow .15s; }
    input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(24,24,27,.08); }
    textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--input-bg); font-size: 13px; font-family: "SF Mono", Consolas, monospace; transition: border-color .15s, box-shadow .15s; resize: vertical; min-height: 60px; }
    textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(24,24,27,.08); }
    input[type="file"] { width: 100%; padding: 10px; border: 2px dashed var(--border); border-radius: var(--radius-sm); background: var(--input-bg); cursor: pointer; transition: border-color .15s; }
    input[type="file"]:hover { border-color: #ccc; }

    .checks { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 8px; }
    .checks label { margin: 0; display: flex; gap: 10px; align-items: center; font-weight: 400; color: var(--text); cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); transition: background .15s; }
    .checks label:hover { background: var(--input-bg); }
    .checks input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent); }

    button { margin-top: 16px; padding: 10px 18px; border: none; border-radius: var(--radius-sm); background: var(--accent); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; transition: background .15s, transform .1s; }
    button:hover { background: var(--accent-hover); }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btns { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .ghost { background: transparent; color: var(--accent); border: 1px solid var(--border); }
    .ghost:hover { background: var(--input-bg); border-color: #ccc; }

    .hint { color: var(--text-muted); font-size: 12px; margin-top: 20px; line-height: 1.7; }
    .out { margin-top: 16px; padding: 14px; background: var(--input-bg); border-radius: var(--radius-sm); }
    .out pre { white-space: pre-wrap; margin: 0; font-size: 13px; font-family: "SF Mono", Consolas, monospace; }
    code { background: var(--input-bg); padding: 2px 8px; border-radius: 6px; font-size: 12px; }

    .progress { height: 6px; background: var(--border); border-radius: 999px; overflow: hidden; margin-top: 20px; }
    .bar { height: 100%; width: 0%; background: var(--accent); transition: width .25s ease; }
    .meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-top: 12px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .tab-btn { padding: 10px 18px; border: none; background: none; cursor: pointer; font-size: 14px; color: var(--text-muted); position: relative; transition: color .15s; font-weight: 500; }
    .tab-btn:hover { color: var(--text); background: var(--input-bg); }
    .tab-btn.active { color: var(--text); }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--accent); border-radius: 2px 2px 0 0; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats & Debug */
    .stats-bar { display: flex; gap: 24px; padding: 16px 20px; background: var(--input-bg); border-radius: var(--radius-sm); margin-bottom: 20px; font-size: 13px; }
    .stats-bar .stat { display: flex; align-items: center; gap: 8px; }
    .stats-bar .stat-label { color: var(--text-muted); }
    .stats-bar .stat-value { font-weight: 600; color: var(--text); }

    .filter-bar { display: flex; gap: 8px; margin-bottom: 20px; }
    .filter-btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--card); cursor: pointer; font-size: 13px; transition: all .15s; color: var(--text-muted); }
    .filter-btn:hover { border-color: #ccc; color: var(--text); background: var(--input-bg); }
    .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    .chunks-table { width: 100%; table-layout: fixed; border-collapse: collapse; font-size: 13px; }
    .chunks-table th { text-align: left; padding: 12px 16px; background: var(--input-bg); font-weight: 500; color: var(--text-muted); }
    .chunks-table th:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
    .chunks-table th:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
    .chunks-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .chunks-table tr:hover td { background: var(--input-bg); }
    .chunks-table th:nth-child(1), .chunks-table td:nth-child(1) { width: 72px; }
    .chunks-table th:nth-child(2), .chunks-table td:nth-child(2) { width: 160px; }
    .chunks-table th:nth-child(3), .chunks-table td:nth-child(3) { width: 80px; }
    .chunks-table th:nth-child(4), .chunks-table td:nth-child(4) { width: 120px; }

    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
    .status-pending { background: #f3f4f6; color: #6b7280; }
    .status-processing { background: #eff6ff; color: #3b82f6; }
    .status-done { background: #f0fdf4; color: #22c55e; }
    .status-error { background: #fef2f2; color: #ef4444; }
    .status-retrying { background: #fffbeb; color: #f59e0b; }
    .error-brief { color: #ef4444; font-size: 12px; display: block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }


    @media (max-width: 600px) {
      body { padding: 20px 16px; }
      .card { padding: 20px; }
      .row { flex-direction: column; gap: 0; }
      input[type="text"], input[type="number"] { width: 100%; }
      .stats-bar { flex-wrap: wrap; gap: 16px; }
      .chunks-table { font-size: 12px; }
      .chunks-table th, .chunks-table td { padding: 10px 12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: -3px; margin-right: 8px;"><path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.3801 15.27V7.57999C18.3801 6.80999 17.7601 6.25 17.0001 6.31H16.9601C15.6201 6.42 13.5901 7.11001 12.4501 7.82001L12.3401 7.89002C12.1601 8.00002 11.8501 8.00002 11.6601 7.89002L11.5001 7.79001C10.3701 7.08001 8.34012 6.40999 7.00012 6.29999C6.24012 6.23999 5.62012 6.81001 5.62012 7.57001V15.27C5.62012 15.88 6.1201 16.46 6.7301 16.53L6.9101 16.56C8.2901 16.74 10.4301 17.45 11.6501 18.12L11.6801 18.13C11.8501 18.23 12.1301 18.23 12.2901 18.13C13.5101 17.45 15.6601 16.75 17.0501 16.56L17.2601 16.53C17.8801 16.46 18.3801 15.89 18.3801 15.27Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8.1001V17.6601" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Novel Proofer</h1>
      <form id="mainForm" action="#" method="post" enctype="multipart/form-data">
      <label>上传 TXT</label>
      <input name="file" type="file" accept=".txt,text/plain" required />

      <!-- Action Area (always visible) -->
      <div class="btns">
        <button type="button" id="btnStart">开始校对</button>
        <button type="button" class="ghost" id="btnPause" style="display:none" disabled>暂停</button>
        <button type="button" class="ghost" id="btnCancel" style="display:none" disabled>取消</button>
        <button type="button" class="ghost" id="btnRetry" style="display:none" disabled>重试失败部分</button>
        <button type="button" class="ghost" id="btnCleanup" style="display:none" disabled>清理中间文件</button>
      </div>

      <div class="progress" id="progress" style="display:none">
        <div class="bar" id="bar"></div>
      </div>
      <div class="meta" id="meta" style="display:none">
        <div id="metaLeft">准备中</div>
        <div id="metaRight">0%</div>
      </div>

      <div class="out" id="out" style="display:none">
        <pre id="outText"></pre>
      </div>

      <div class="hint">
        <div>默认启用 LLM；会按"分片大小"分片并发处理（并发表示同时在飞请求数，不是一次处理总字数）。</div>
        <div>如果部分分片失败，可修改 LLM 配置后点击"重试失败部分"。</div>
        <div>如遇到 token limit / 输出过短，可在"额外参数"里尝试设置输出上限（例如 <code>{"max_tokens": 4096}</code>；不同服务参数名可能不同）。</div>
        <div>如需排查中间结果，可取消勾选"完成后删除调试中间文件"；中间文件位于 <code>output/.jobs/</code>。</div>
        <div>完成后结果会写入项目 <code>output/</code> 目录。</div>
      </div>

      <!-- Tab Navigation -->
      <div class="tabs">
        <button type="button" class="tab-btn active" data-tab="progress">参数设置</button>
        <button type="button" class="tab-btn" data-tab="debug">分析进度</button>
      </div>

      <!-- Progress Tab -->
      <div id="tab-progress" class="tab-content active">

        <div class="row">
          <div>
            <label>输出后缀</label>
            <input name="suffix" type="text" value="_rev" />
          </div>
          <div>
            <label>分片大小（字符数）</label>
            <input name="max_chunk_chars" type="number" min="200" max="4000" step="100" value="2000" />
          </div>
        </div>

        <label>规则开关</label>
        <div class="checks">
          <label><input type="checkbox" name="paragraph_indent" value="1" checked />段首统一缩进</label>
          <label><input type="checkbox" name="indent_with_fullwidth_space" value="1" checked />缩进用全角空格（\u3000）</label>
          <label><input type="checkbox" name="normalize_blank_lines" value="1" checked />过多空行压缩</label>
          <label><input type="checkbox" name="trim_trailing_spaces" value="1" checked />去掉行尾空格</label>
          <label><input type="checkbox" name="normalize_ellipsis" value="1" checked />省略号统一为“……”</label>
          <label><input type="checkbox" name="normalize_em_dash" value="1" checked />破折号统一为“——”</label>
          <label><input type="checkbox" name="normalize_cjk_punctuation" value="1" checked />中英文标点统一（CJK 场景）</label>
          <label><input type="checkbox" name="fix_cjk_punct_spacing" value="1" checked />标点与汉字间去空格</label>
          <label><input type="checkbox" name="normalize_quotes" value="1" />引号统一为中文引号（谨慎）</label>
        </div>

        <label>LLM（可选，用于更复杂的对话/标点处理）</label>
        <div class="row">
          <div>
            <input type="hidden" name="llm_enabled" value="0" />
            <label><input type="checkbox" name="llm_enabled" value="1" checked />启用 LLM（默认）</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Base URL</label>
            <input name="llm_base_url" type="text" value="https://juya.owl.ci" />
          </div>
          <div>
            <label>Model</label>
            <input name="llm_model" type="text" value="DeepSeek-V3.2-Exp" />
          </div>
          <div>
            <label>API Key（可留空）</label>
            <input name="llm_api_key" type="text" placeholder="sk-..." />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Temperature</label>
            <input name="llm_temperature" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>超时（秒）</label>
            <input name="llm_timeout_seconds" type="number" step="1" value="180" />
          </div>
          <div>
            <label>并发（LLM）</label>
            <input name="llm_max_concurrency" type="number" min="1" step="1" value="20" />
          </div>
        </div>
        <div class="row">
          <div>
            <input type="hidden" name="llm_filter_think_tags" value="0" />
            <label><input type="checkbox" name="llm_filter_think_tags" value="1" checked />过滤 &lt;think&gt;…&lt;/think&gt;（默认）</label>
          </div>
        </div>

        <label>调试</label>
        <div class="row">
          <div>
            <input type="hidden" name="cleanup_debug_dir" value="0" />
            <label><input type="checkbox" name="cleanup_debug_dir" value="1" checked />完成后删除调试中间文件（默认）</label>
          </div>
        </div>
        <div>
          <label>额外参数（JSON，可选，透传给 LLM）</label>
          <textarea name="llm_extra_params" placeholder='例如：{"max_tokens": 4096}'></textarea>
        </div>
      </div>
      </form>

      <!-- Debug Tab -->
      <div id="tab-debug" class="tab-content">
        <div class="stats-bar" id="statsBar">
          <div class="stat"><span class="stat-label">总计:</span> <span class="stat-value" id="statTotal">0</span></div>
          <div class="stat"><span class="stat-label">完成:</span> <span class="stat-value" id="statDone">0</span></div>
          <div class="stat"><span class="stat-label">错误:</span> <span class="stat-value" id="statError">0</span></div>
          <div class="stat"><span class="stat-label">重试:</span> <span class="stat-value" id="statRetrying">0</span></div>
        </div>

        <div class="filter-bar">
          <button type="button" class="filter-btn active" data-filter="all">全部</button>
          <button type="button" class="filter-btn" data-filter="error">仅错误</button>
        </div>

        <div id="chunksTableWrap">
          <table class="chunks-table">
            <thead>
              <tr>
          <th>#</th>
          <th>状态</th>
          <th>重试</th>
          <th>输入/输出</th>
          <th>错误信息</th>
              </tr>
            </thead>
            <tbody id="chunksBody"></tbody>
          </table>
        </div>

        <div id="noChunksHint" style="color:#999; font-size:13px; text-align:center; padding:40px 0;">
          暂无分片数据，请先开始校对任务。
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const form = document.getElementById('mainForm');
    const out = document.getElementById('out');
    const outText = document.getElementById('outText');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const meta = document.getElementById('meta');
    const metaLeft = document.getElementById('metaLeft');
    const metaRight = document.getElementById('metaRight');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const btnCancel = document.getElementById('btnCancel');
    const btnRetry = document.getElementById('btnRetry');
    const btnCleanup = document.getElementById('btnCleanup');

    // Debug tab elements
    const chunksBody = document.getElementById('chunksBody');
    const noChunksHint = document.getElementById('noChunksHint');
    const chunksTableWrap = document.getElementById('chunksTableWrap');
    const statTotal = document.getElementById('statTotal');
    const statDone = document.getElementById('statDone');
    const statError = document.getElementById('statError');
    const statRetrying = document.getElementById('statRetrying');

    let currentJobId = null;
    let currentJobState = null;
    let currentFilter = 'all';
    let activeTab = 'progress';
    let forceChunksFetch = false;
    let chunksData = [];
    let chunkCounts = null;
    let totalChunksFromServer = 0;
    let chunksFetchInFlight = false;

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
      activeTab = tabName;
      tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
      tabContents.forEach(content => content.classList.toggle('active', content.id === 'tab-' + tabName));
      localStorage.setItem('activeTab', tabName);
      if (tabName === 'debug' && currentJobId) {
        forceChunksFetch = true;
        refreshChunksNow(currentJobId);
      }
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Restore tab from localStorage
    const savedTab = localStorage.getItem('activeTab');
    switchTab(savedTab || 'progress');

    // Filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        filterBtns.forEach(b => b.classList.toggle('active', b === btn));
        if (activeTab === 'debug' && currentJobId) {
          forceChunksFetch = true;
          refreshChunksNow(currentJobId);
        } else {
          renderChunksTable();
        }
      });
    });

    function getStatusBadge(state) {
      const icons = { pending: '[ ]', processing: '[~]', done: '[v]', error: '[!]', retrying: '[*]' };
      const labels = { pending: '待处理', processing: '处理中', done: '完成', error: '错误', retrying: '重试中' };
      const icon = icons[state] || '[ ]';
      const label = labels[state] || state;
      return `<span class="status-badge status-${state}">${icon} ${label}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function truncateStr(s, maxLen) {
      const str = String(s || '');
      const n = Number(maxLen || 0);
      if (!Number.isFinite(n) || n <= 0) return str;
      if (str.length <= n) return str;
      return str.slice(0, n) + '…';
    }

    function tryParseJson(s) {
      try {
        return JSON.parse(s);
      } catch (e) {
        return null;
      }
    }

    function formatErrorDisplay(code, message) {
      const codeStr = (code == null || code === '') ? '' : String(code);
      const msg = (message == null) ? '' : String(message).trim();

      if (!codeStr && !msg) return null;

      const httpMatch = msg.match(/^HTTP\s+(\d+)\s+from\s+LLM:\s*(.*)$/i);
      if (httpMatch) {
        const httpCode = httpMatch[1] || codeStr || '';
        const body = String(httpMatch[2] || '').trim();

        let reason = '';
        if (body) {
          const parsed = (body.startsWith('{') || body.startsWith('[')) ? tryParseJson(body) : null;
          if (parsed && parsed.error && parsed.error.message) reason = String(parsed.error.message);
          else if (parsed && parsed.message) reason = String(parsed.message);
          else reason = body;
        }

        const brief = httpCode ? `HTTP ${httpCode}` : 'HTTP error';
        const detail = reason ? `${brief}: ${reason}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      if (/LLM output empty/i.test(msg)) {
        return { brief: 'LLM output empty', detail: 'LLM output empty' };
      }

      if (/LLM output too short/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too short (ratio=${m[1]})` : 'LLM output too short';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (/LLM output too long/i.test(msg)) {
        const m = msg.match(/ratio=([0-9.]+)/i);
        const brief = m ? `LLM output too long (ratio=${m[1]})` : 'LLM output too long';
        return { brief: truncateStr(brief, 60), detail: truncateStr(msg || brief, 300) };
      }

      if (codeStr) {
        const brief = `HTTP ${codeStr}`;
        const detail = msg ? `${brief}: ${msg}` : brief;
        return { brief: truncateStr(brief, 40), detail: truncateStr(detail, 300) };
      }

      const brief = truncateStr(msg, 60);
      return { brief, detail: truncateStr(msg, 300) };
    }

    function renderChunksTable() {
      if (!chunksData || chunksData.length === 0) {
        noChunksHint.style.display = 'block';
        chunksTableWrap.style.display = 'none';
        if (currentJobId) {
          if (currentFilter === 'all') {
            noChunksHint.textContent = '暂无分片数据（可切换到调试信息页以加载）。';
          } else {
            noChunksHint.textContent = '当前过滤条件下无匹配分片。';
          }
        } else {
          noChunksHint.textContent = '暂无分片数据，请先开始校对任务。';
        }
        return;
      }

      noChunksHint.style.display = 'none';
      chunksTableWrap.style.display = 'block';

       const rows = chunksData.slice(0, 500).map(c => {
         let inOut = '-';
         if (c.input_chars != null && c.output_chars != null) inOut = `${c.input_chars}/${c.output_chars}`;
         else if (c.input_chars != null) inOut = `${c.input_chars}/-`;

         const errCode = (c.last_error_code != null) ? String(c.last_error_code) : '';
         const errFull = c.last_error_message ? String(c.last_error_message) : '';
         const err = formatErrorDisplay(errCode, errFull);
         const errMsg = err
           ? `<span class="error-brief" title="${escapeHtml(err.detail)}">${escapeHtml(err.brief)}</span>`
           : '-';

         return `<tr>
           <td>${c.index}</td>
           <td>${getStatusBadge(c.state)}</td>
           <td>${c.retries}</td>
           <td>${inOut}</td>
           <td>${errMsg}</td>
         </tr>`;
       }).join('');


      chunksBody.innerHTML = rows;
    }

    function updateStats() {
      const counts = chunkCounts || {};
      statTotal.textContent = String(totalChunksFromServer || 0);
      statDone.textContent = String(counts.done || 0);
      statError.textContent = String(counts.error || 0);
      statRetrying.textContent = String(counts.retrying || 0);
    }

    function showChunks(data) {
      if (!data || !Array.isArray(data.chunks)) return;

      chunksData = data.chunks;
      chunkCounts = data.chunk_counts || null;
      totalChunksFromServer = Number(data?.job?.progress?.total_chunks || 0);
      updateStats();
      renderChunksTable();
    }

    async function refreshChunksNow(jobId) {
      if (!jobId) return;
      if (chunksFetchInFlight) return;
      chunksFetchInFlight = true;
      try {
        const q = new URLSearchParams({ chunks: '1' });
        q.set('chunk_state', currentFilter);
        q.set('limit', '500');
        q.set('offset', '0');

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) {
          show(data);
          return;
        }
        showChunks(data);
      } catch (e) {
        show(String(e));
      } finally {
        chunksFetchInFlight = false;
      }
    }

    function show(obj) {
      out.style.display = 'block';
      outText.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    function setProgress(done, total, state) {
      progress.style.display = 'block';
      meta.style.display = 'flex';
      const pct = total > 0 ? Math.floor((done / total) * 100) : (state === 'done' ? 100 : 0);
      bar.style.width = pct + '%';
      metaLeft.textContent = `${state}  ${done}/${total}`;
      metaRight.textContent = pct + '%';
      // Update status text based on state
      const stateLabels = {
        queued: '已提交，准备开始…',
        running: '正在处理中…',
        paused: '已暂停',
        done: '处理完成',
        cancelled: '已取消',
        error: '处理出错'
      };
      if (stateLabels[state]) {
        out.style.display = 'block';
        outText.textContent = stateLabels[state];
      }
    }

    function setBusy(busy) {
      btnStart.disabled = busy;
      btnPause.style.display = busy ? 'inline-block' : 'none';
      btnPause.disabled = !busy;
      btnPause.textContent = '暂停';
      btnCancel.style.display = busy ? 'inline-block' : 'none';
      btnCancel.disabled = !busy;
      if (busy) {
        btnRetry.style.display = 'none';
        btnRetry.disabled = true;
        btnCleanup.style.display = 'none';
        btnCleanup.disabled = true;
      }
    }

    function setPaused(paused) {
      btnStart.disabled = false;
      btnPause.style.display = paused ? 'inline-block' : 'none';
      btnPause.disabled = !paused;
      btnPause.textContent = '继续';
      btnCancel.style.display = paused ? 'inline-block' : 'none';
      btnCancel.disabled = !paused;
      btnRetry.style.display = 'none';
      btnRetry.disabled = true;
      btnCleanup.style.display = 'none';
      btnCleanup.disabled = true;
    }

    function setRetryVisible(visible) {
      btnRetry.style.display = visible ? 'inline-block' : 'none';
      btnRetry.disabled = !visible;
    }

    function setCleanupVisible(visible) {
      btnCleanup.style.display = visible ? 'inline-block' : 'none';
      btnCleanup.disabled = !visible;
    }

    function parseExtraParamsFromFormData(fd) {
      const raw = String(fd.get('llm_extra_params') || '').trim();
      if (!raw) return { ok: true, value: null };
      try {
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) {
          return { ok: false, error: '额外参数必须是 JSON 对象（例如 {"max_tokens": 4096}）。' };
        }
        return { ok: true, value: obj };
      } catch (e) {
        return { ok: false, error: '额外参数 JSON 无效，请检查括号/引号/逗号。' };
      }
    }

    function buildLlmOptions(fd, extraParamsValue) {
      const llmEnabled = !!document.querySelector('input[type="checkbox"][name="llm_enabled"]')?.checked;
      const filterThinkTags = !!document.querySelector('input[type="checkbox"][name="llm_filter_think_tags"]')?.checked;

      return {
        enabled: llmEnabled,
        base_url: String(fd.get('llm_base_url') || ''),
        api_key: String(fd.get('llm_api_key') || ''),
        model: String(fd.get('llm_model') || ''),
        temperature: Number(fd.get('llm_temperature') || 0),
        timeout_seconds: Number(fd.get('llm_timeout_seconds') || 180),
        max_concurrency: Number(fd.get('llm_max_concurrency') || 20),
        extra_params: extraParamsValue,
        filter_think_tags: filterThinkTags,
      };
    }

    function buildJobOptions(fd, extraParamsValue) {
      const cleanupDebugDir = !!document.querySelector('input[type="checkbox"][name="cleanup_debug_dir"]')?.checked;
      return {
        format: {
          max_chunk_chars: Number(fd.get('max_chunk_chars') || 2000),
          paragraph_indent: fd.get('paragraph_indent') != null,
          indent_with_fullwidth_space: fd.get('indent_with_fullwidth_space') != null,
          normalize_blank_lines: fd.get('normalize_blank_lines') != null,
          trim_trailing_spaces: fd.get('trim_trailing_spaces') != null,
          normalize_ellipsis: fd.get('normalize_ellipsis') != null,
          normalize_em_dash: fd.get('normalize_em_dash') != null,
          normalize_cjk_punctuation: fd.get('normalize_cjk_punctuation') != null,
          fix_cjk_punct_spacing: fd.get('fix_cjk_punct_spacing') != null,
          normalize_quotes: fd.get('normalize_quotes') != null,
        },
        llm: buildLlmOptions(fd, extraParamsValue),
        output: {
          suffix: String(fd.get('suffix') || '_rev'),
          cleanup_debug_dir: cleanupDebugDir,
        },
      };
    }

    async function requestCancel(jobId) {
      if (!jobId) return;
      try {
        await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cancel`, { method: 'POST' });
      } catch (e) {}
    }

    async function requestPause(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/pause`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    async function requestResume(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnPause.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;

      // Resume when paused; otherwise pause.
      if (currentJobState === 'paused') {
        show('继续分析…');
        setBusy(true);
        setRetryVisible(false);
        setCleanupVisible(false);
        const r = await requestResume(jobId);
        if (!r.ok) {
          show(r.error);
          setPaused(true);
          return;
        }
        currentJobState = 'running';
        await poll(jobId);
        return;
      }

      btnPause.disabled = true;
      show('正在暂停…');
      const r = await requestPause(jobId);
      if (!r.ok) {
        show(r.error);
        btnPause.disabled = false;
      }
    });

    btnCancel.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      currentJobId = null;
      currentJobState = null;
      setProgress(0, 0, 'cancelled');
      show('已取消。');
      setBusy(false);
      setRetryVisible(false);
      setCleanupVisible(false);
      await requestCancel(jobId);
    });

    async function requestRetryFailed(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) return { ok: false, error: extra.error };
      const payload = { llm: buildLlmOptions(fd, extra.value) };

      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/retry-failed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnRetry.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      show('准备重试失败分片…');
      setBusy(true);
      setRetryVisible(false);
      setCleanupVisible(false);
      const r = await requestRetryFailed(jobId);
      if (!r.ok) {
        show(r.error);
        setBusy(false);
        setRetryVisible(true);
        setCleanupVisible(true);
        return;
      }
      await poll(jobId);
    });

    async function requestCleanup(jobId) {
      if (!jobId) return { ok: false, error: 'missing job_id' };
      try {
        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}/cleanup-debug`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) return { ok: false, error: data };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    btnCleanup.addEventListener('click', async () => {
      const jobId = currentJobId;
      if (!jobId) return;
      const ok = confirm('确认清理中间文件？清理后将无法继续重试失败部分。');
      if (!ok) return;

      btnCleanup.disabled = true;
      show('正在清理中间文件…');
      const r = await requestCleanup(jobId);
      if (!r.ok) {
        show(r.error);
        btnCleanup.disabled = false;
        return;
      }

      show('已清理中间文件。');
      setRetryVisible(false);
      setCleanupVisible(false);
      currentJobId = null;
      currentJobState = null;
      chunksData = [];
      updateStats();
      renderChunksTable();
    });

    async function poll(jobId) {
      while (true) {
        if (!currentJobId || currentJobId !== jobId) return;

        const wantChunks = (activeTab === 'debug') || forceChunksFetch;
        forceChunksFetch = false;

        const q = new URLSearchParams({ chunks: wantChunks ? '1' : '0' });
        if (wantChunks) {
          q.set('chunk_state', currentFilter);
          q.set('limit', '500');
          q.set('offset', '0');
        }

        const res = await fetch(`api/v1/jobs/${encodeURIComponent(jobId)}?${q.toString()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data));

        currentJobState = data?.job?.state;
        setProgress(data?.job?.progress?.done_chunks || 0, data?.job?.progress?.total_chunks || 0, data?.job?.state);
        if (wantChunks) showChunks(data);

        if (data?.job?.state === 'done') {
          show(data?.job?.output_path ? `完成。已输出到：${data.job.output_path}` : '完成。已输出到项目 output/ 目录。');
          setBusy(false);
          currentJobId = null;
          currentJobState = null;
          setRetryVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'cancelled') {
          show('已取消。');
          setBusy(false);
          currentJobId = null;
          currentJobState = null;
          setRetryVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'paused') {
          show('已暂停。');
          setBusy(false);
          setPaused(true);
          setRetryVisible(false);
          setCleanupVisible(false);
          return;
        }

        if (data?.job?.state === 'error') {
          show(data?.job?.error || data);
          setBusy(false);
          setRetryVisible(true);
          setCleanupVisible(true);
          return;
        }

        await new Promise(r => setTimeout(r, 800));
      }
    }

    // btnStart click triggers form submit (button is outside form)
    btnStart.addEventListener('click', () => {
      form.requestSubmit();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (currentJobId && (currentJobState === 'queued' || currentJobState === 'running' || currentJobState === 'paused')) return;
      currentJobId = null;
      currentJobState = null;
      setRetryVisible(false);
      setCleanupVisible(false);

      const fd = new FormData(form);
      const extra = parseExtraParamsFromFormData(fd);
      if (!extra.ok) {
        show(extra.error);
        return;
      }
      const maxChunkChars = Number(fd.get('max_chunk_chars') || 0);
      if (!Number.isFinite(maxChunkChars) || maxChunkChars < 2000 || maxChunkChars > 4000) {
        show('分片大小（字符数）必须在 2000-4000 之间。');
        return;
      }
      show('已提交，准备开始…');
      setProgress(0, 0, 'queued');
      setBusy(true);

      const file = fd.get('file');
      if (!(file instanceof File)) {
        show('请选择 TXT 文件。');
        setBusy(false);
        return;
      }
      const opts = buildJobOptions(fd, extra.value);
      const requestFd = new FormData();
      requestFd.append('file', file);
      requestFd.append('options', JSON.stringify(opts));

      const res = await fetch('api/v1/jobs', { method: 'POST', body: requestFd });
      const data = await res.json();
      if (!res.ok) {
        show(data);
        setBusy(false);
        return;
      }

      currentJobId = data?.job?.id;
      currentJobState = 'queued';
      await poll(currentJobId);
    });
  </script>
</body>
</html>
