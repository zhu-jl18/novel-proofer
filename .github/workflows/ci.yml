name: ci

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: lint + test (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        python-version: ["3.12", "3.14"]
    env:
      NOVEL_PROOFER_RUN_LLM_TESTS: "false"
      UV_NO_PROGRESS: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
      - name: Sync deps
        shell: bash
        run: |
          uv sync --frozen --no-install-project --group dev
      - name: Ruff format (check)
        shell: bash
        run: |
          uv run --frozen --no-sync ruff format --check
      - name: Ruff lint
        shell: bash
        run: |
          uv run --frozen --no-sync ruff check
      - name: Mypy
        shell: bash
        run: |
          uv run --frozen --no-sync mypy novel_proofer
      - name: Pytest
        shell: bash
        run: |
          uv run --frozen --no-sync pytest -q

  frontend_css:
    name: frontend css (tailwind build)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Build tailwind.css
        run: |
          npm ci
          npm run build:css
      - name: Ensure tailwind.css is up-to-date
        run: |
          git diff --exit-code -- templates/static/css/tailwind.css
