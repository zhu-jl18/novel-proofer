# 使用指南

## 目录

1. [安装与启动](#安装与启动)
2. [本地校对规则](#本地校对规则)
3. [LLM 校对模块](#llm-校对模块)
4. [异常处理与校验](#异常处理与校验)
5. [调试信息](#调试信息)

---

## 安装与启动

双击 `start.bat` 启动，或手动执行以下命令：

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
python -m novel_proofer.server
```

启动后访问 http://127.0.0.1:18080 。

上传 `.txt` 文件后系统自动执行排版处理。全部成功时，最终结果输出到 `output/` 目录；部分失败时，可修改 LLM 配置后点击「重试失败部分」，全部成功后才会生成最终输出文件。若输出明显异常（过短或过长），该分片会标记失败，建议更换模型或调整输出上限后重试。

---

## 本地校对规则

本地规则在 `novel_proofer/formatting/rules.py` 中实现，按顺序依次执行：

| 规则         | 实现逻辑                                                                           |
| ------------ | ---------------------------------------------------------------------------------- |
| 换行符统一   | `\r\n` 和 `\r` 全部替换为 `\n`                                                     |
| 行尾空格清理 | 正则 `[ \t]+(?=\n)` 移除行尾空白                                                   |
| 空行规范化   | 连续 2+ 空行压缩为 1 空行                                                          |
| 省略号统一   | `...`、`。。。` 等统一为 `……`（两个 U+2026）                                       |
| 破折号统一   | `--`、`——` 等统一为 `——`（两个 U+2014）                                            |
| 中文标点转换 | 仅在 CJK 上下文中将 ASCII 标点转为全角（如 `,` → `，`），跳过数字场景（如 `3.14`） |
| 标点间距修复 | 移除汉字与标点之间的多余空格                                                       |
| 引号规范化   | 偶数 `"` 的行将 `"` 成对替换为中文引号 `""`（仅处理含 CJK 字符的行）               |
| 段落缩进     | 正文段落添加两个全角空格缩进，章节标题不缩进                                       |

注：章节标题识别是启发式规则；除“第X章/序章/番外”等外，也会识别全大写英文标题（如 `PROLOGUE`）。为避免误判，英文标题识别仅在该行不含 CJK 字符时生效。

---

## LLM 校对模块

本地规则是确定性的字符替换，无法理解语义。LLM 用于处理本地规则难以判断的场景：对话与叙述的分段、场景转换的段落分隔、章节标题格式调整、以及复杂标点上下文的修正。LLM 使用的系统提示词定义在 `novel_proofer/llm/config.py` 中。

处理流程为：输入文本 → 按段落边界分片 → 本地规则预处理 → LLM 流式请求/重试/校验 → 本地规则二次收敛 → 合并输出。

### 分片大小

UI 的「分片大小（字符数）」控制每个 chunk 的目标上限（按"行"累积；优先在空行/段落边界处分块）。允许范围为 200–4000（步进 100）。

首个分片会被"保护"为至少 2000 字符（但仍不超过 4000），以尽量把广告/标签/简介等前置信息放进第 1 个 chunk，从而使用首分片专用提示词清理；第 2 个及之后的分片仍按你设置的分片大小切分。

边界情况：如果原文存在"单行超长"（一行就超过上限），由于切分按行进行，该行会完整落在某个 chunk 中，因此可能超过你设置的上限。

### 支持的 LLM 端点

OpenAI-compatible（`{base_url}/chat/completions`，SSE 流式）。

注：如果你的 API 端点需要 `/v1` 前缀，请在 base_url 中包含，例如 `https://api.openai.com/v1`。

---

## 异常处理与校验

### HTTP 错误重试

状态码 408、409、425、429、500、502、503、504 会自动重试（最多 2 次，指数退避）。其他状态码（如 401、403）立即报错，不重试。

### 输出校验

LLM 返回后进行长度校验以防止内容丢失：
- 输出为空时报告 token 限制或流解析问题
- 输入 ≥200 字符时，若输出/输入比值 < 0.85 则判定过短，> 1.15 则判定过长，均标记为失败

### 合并输出

合并分片输出时会统一换行符，并在相邻非空行之间补齐一个空行，避免分片边界丢失段落分隔；分片内部空行会被本地规则收敛为最多 1 个空行，避免出现段落间距过大。

### Think 标签过滤

部分模型（如 DeepSeek）会输出 `<think>...</think>` 推理过程。系统会**强制过滤**此类内容（不可关闭）：使用状态机流式过滤，支持跨 chunk 边界；若检测到未闭合标签，回退为仅移除标签标记、保留内容。

---

## 调试信息

每个任务在 `output/.jobs/{job_id}/` 下保存中间文件，用于排查与重试。默认情况下任务全部成功后会自动删除该目录；如需保留可在 UI 取消勾选「完成后删除调试中间文件」；任务失败时不会自动删除，可在 UI 点击「清理中间文件」手动删除。

### 目录结构

```
output/.jobs/{job_id}/
├── README.txt
├── pre/{index:06d}.txt   # 发送给 LLM 的分片输入
├── out/{index:06d}.txt   # 分片最终输出（通过校验）
└── resp/{index:06d}.txt  # LLM 原始响应（覆盖式）
```

### UI 调试面板

位于「分析进度」标签页，提供：
- 统计栏：总计/完成/错误/重试中分片数
- 过滤器：全部/仅错误/仅重试
- 分片表格：状态、重试次数、输入输出字符数、错误信息

### 分片状态

| 状态 | 说明 |
|------|------|
| `pending` | 等待处理 |
| `processing` | 正在请求 |
| `retrying` | 等待重试 |
| `done` | 处理完成 |
| `error` | 处理失败 |
