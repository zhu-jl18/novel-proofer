# 使用指南

## 目录

1. [安装与启动](#安装与启动)
2. [本地校对规则](#本地校对规则)
3. [LLM 校对模块](#llm-校对模块)
4. [异常处理与校验](#异常处理与校验)
5. [调试信息](#调试信息)

---

## 安装与启动

双击 `start.bat` 启动，或手动执行以下命令：

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
python -m novel_proofer.server
```

启动后访问 http://127.0.0.1:18080 。

上传 `.txt` 文件后，系统按 **三阶段工作流（v2）** 运行：

1) **开始校验**：解码、切片、确定性规则预处理，生成可恢复中间态；完成后任务会暂停，等待下一步。
2) **开始处理**：对分片进行 LLM 处理与校验（含自动重试）；失败时任务进入 `error`，可修改 LLM 配置后点击「重试失败部分」。
3) **合并输出**：全部分片成功后，点击「合并输出」生成最终结果文件（可选“合并后清理中间产物”）。

如果你刷新/关闭页面，后台任务仍会继续；重新打开页面后可通过「加载任务」重新连接并继续操作。

输出文件名格式为：`output/{job_id}_{原文件名}{suffix}{ext}`。其中 `suffix` 默认为 `_rev`，可在 UI 的「输出后缀」中自定义（仅影响文件名，不影响正文内容）。

### LLM 默认配置（.env，可选）

为了避免每次启动都在页面重复填写 Base URL / Model / API Key，系统支持将 LLM 配置保存为“默认值”：

- 页面填写好 LLM 配置后点击「保存默认」，服务端会将其写入仓库根目录 `.env`（已在 `.gitignore` 中忽略）。
- 也可以手动复制 `.env.example` 为 `.env` 并填写。

注意：`.env` 可能包含 API Key，请勿提交到仓库。

---

## 本地校对规则

本地规则在 `novel_proofer/formatting/rules.py` 中实现，按顺序依次执行：

| 规则         | 实现逻辑                                                                           |
| ------------ | ---------------------------------------------------------------------------------- |
| 换行符统一   | `\r\n` 和 `\r` 全部替换为 `\n`                                                     |
| 行尾空格清理 | 正则 `[ \t]+(?=\n)` 移除行尾空白                                                   |
| 空行规范化   | 连续 2+ 空行压缩为 1 空行                                                          |
| 省略号统一   | `...`、`。。。` 等统一为 `……`（两个 U+2026）                                       |
| 破折号统一   | `--`、`——` 等统一为 `——`（两个 U+2014）                                            |
| 中文标点转换 | 仅在 CJK 上下文中将 ASCII 标点转为全角（如 `,` → `，`），跳过数字场景（如 `3.14`） |
| 标点间距修复 | 移除汉字与标点之间的多余空格                                                       |
| 引号规范化   | 偶数 `"` 的行将 `"` 成对替换为中文引号 `""`（仅处理含 CJK 字符的行）               |
| 段落缩进     | 正文段落添加两个全角空格缩进，章节标题不缩进                                       |

注：章节标题识别是启发式规则；除“第X章/序章/番外”等外，也会识别全大写英文标题（如 `PROLOGUE`）。为避免误判，英文标题识别仅在该行不含 CJK 字符时生效。

---

## LLM 校对模块

本地规则是确定性的字符替换，无法理解语义。LLM 用于处理本地规则难以判断的场景：对话与叙述的分段、场景转换的段落分隔、章节标题格式调整、以及复杂标点上下文的修正。LLM 使用的系统提示词定义在 `novel_proofer/llm/config.py` 中。

提示词除排版规则外，还会要求清理常见垃圾行：广告/引流/水印/群链接，以及仅由 `====/----/***` 等重复符号组成的分隔线（避免误删包含正文内容的行）。首个分片另外会执行“前置信息清理”（作者/标签/简介等）。

处理流程为：输入文本 → 按段落边界分片 → 本地规则预处理 → LLM 流式请求/重试/校验 → 本地规则二次收敛 → 合并输出。

### 分片大小

UI 的「分片大小（字符数）」控制每个 chunk 的目标上限（按"行"累积；优先在空行/段落边界处分块）。允许范围为 200–4000（步进 100）。

首个分片会被"保护"为至少 2000 字符（但仍不超过 4000），以尽量把广告/标签/简介等前置信息放进第 1 个 chunk，从而使用首分片专用提示词清理；第 2 个及之后的分片仍按你设置的分片大小切分。

边界情况：如果原文存在"单行超长"（一行就超过上限），由于切分按行进行，该行会完整落在某个 chunk 中，因此可能超过你设置的上限。

### 支持的 LLM 端点

OpenAI-compatible（`{base_url}/chat/completions`，SSE 流式）。

注：如果你的 API 端点需要 `/v1` 前缀，请在 base_url 中包含，例如 `https://api.openai.com/v1`。
注：API Key 对 OpenAI 官方端点一般必填；对本地/内网兼容端点可留空。

### 失败后：重试失败部分 vs 重跑全部（新任务）

当任务处于 `error`（部分分片失败）时有两种选择：

1) **重试失败部分**：仅重跑失败分片，保留已完成分片结果；优点是更省时间/费用，但最终输出可能混用不同配置/模型处理的分片。
2) **重跑全部（新任务）**：使用当前页面的 LLM 配置从头重跑全部分片，并创建一个全新的任务；优点是输出一致性更强，且**无需重新上传文件**。（该能力目前主要通过 API 端点提供，UI 以三阶段流程为主。）

---

## 异常处理与校验

### HTTP 错误重试

状态码 408、409、425、429、500、502、503、504 会自动重试（最多 2 次，指数退避）。其他状态码（如 401、403）立即报错，不重试。

### 输出校验

LLM 返回后进行长度校验以防止内容丢失：
- 输出为空时报告 token 限制或流解析问题
- 输入 ≥200 字符时，若输出/输入比值 < 0.85 则判定过短，> 1.15 则判定过长，均标记为失败

### 合并输出

合并输出是一个显式动作：只有当所有分片都成功后才允许执行。合并时会统一换行符，并在相邻非空行之间补齐一个空行，避免分片边界丢失段落分隔；分片内部空行会被本地规则收敛为最多 1 个空行，避免出现段落间距过大。

### Think 标签过滤

部分模型（如 DeepSeek）会输出 `<think>...</think>` 推理过程。系统会**强制过滤**此类内容（不可关闭）：使用状态机流式过滤，支持跨 chunk 边界；若检测到未闭合标签，回退为仅移除标签标记、保留内容。

---

## 调试信息

每个任务在 `output/.jobs/{job_id}/` 下保存中间文件，用于排查与重试。默认情况下在「合并输出」阶段会按 UI 选项清理该目录；如需保留可取消勾选「合并后清理中间产物（output/.jobs）」；任务失败时不会自动删除。

### 按钮语义与清理影响（可恢复性对照表）

本项目的“状态恢复/可恢复”指的是：**你可以在刷新页面、关闭页面、甚至服务重启后，通过「加载任务」重新关联到某个 `job_id`**。重新关联后：
- 任务若处于 `queued/running`：可以查看状态与进度；待其进入 `paused` 后再继续下一步。
- 任务若处于 `paused`：可以继续执行后续阶段（预处理→校对→合并）。
- 任务若处于 `done`：可以下载输出或开始新任务。

核心结论：
- **「新任务」不是“删除任务”**：它只会让 UI 解除当前关联，任务与中间产物仍保留（可稍后通过「加载任务」回来继续/下载）。
- **真正不可恢复的是「删除任务 / 删除任务记录」**：会删除任务目录、输入缓存、状态持久化记录，并从任务列表移除（不会删除 `output/` 下的最终输出文件）。
- 浏览器出于安全限制**无法恢复“文件选择框里选中的本地文件”**；加载任务依赖服务端缓存的输入文本，不需要重新选择文件。
- 「已加载任务」状态下右侧的“字数”优先来自服务端输入缓存（`output/.inputs/{job_id}.txt`）；若该缓存缺失但 `output/.jobs/{job_id}/pre/` 仍在，会从分片输入汇总统计；两者都不存在时，UI 会显示 `-` 或 “读取失败”。
- 刷新/关闭页面时，如果任务处于 LLM 校对阶段且仍在运行，UI 会 best-effort 触发一次“暂停”（网络/浏览器限制下不保证 100% 成功；强保证请手动点「暂停」）。

目录/记录的含义：
- `output/.jobs/{job_id}/`：分片级调试产物（`pre/out/resp`），用于排障与复盘
- `output/.inputs/{job_id}.txt`：输入缓存，用于“重跑全部（新任务）无需重新上传”
- `output/.state/jobs/{job_id}.json`：任务状态持久化，用于服务重启后的状态恢复与「加载任务」
- `output/{job_id}_...txt`：最终输出文件（合并后生成）

| UI 文案（按钮/选项） | 触发的服务端动作 | 删除哪些内容 | 还能恢复什么 / 不能恢复什么 |
| --- | --- | --- | --- |
| 开始预处理 | 创建新任务并缓存输入、开始 validate | 不删除 | 可刷新/重启后加载任务继续；可进入后续校对/合并 |
| 开始校对 / 继续校对 | 继续 process 阶段 | 不删除 | 可暂停、可出错后重试失败部分；可刷新/重启后继续 |
| 暂停 | 将运行中的任务置为 `paused`（仅 process 可用） | 不删除 | 可继续校对；可刷新/重启后继续 |
| 重试失败部分 | 将失败分片重置为 pending 并继续 process | 不删除 | 仅重跑失败分片；可刷新/重启后继续 |
| 合并输出 | 合并分片输出为最终文件 | 取决于是否勾选「合并后清理中间产物（output/.jobs）」 | 合并后可下载输出；是否保留 `output/.jobs/{job_id}/` 影响排障/复盘，但不影响状态恢复 |
| 合并后清理中间产物（output/.jobs） | 合并成功后 best-effort 删除 `output/.jobs/{job_id}/` | `output/.jobs/{job_id}/` | 不影响下载最终输出、不影响加载任务查看状态；但无法再用 `pre/out/resp` 排查/复盘该次运行 |
| 下载输出 | 下载 `output/{job_id}_...` | 不删除 | 不影响任何可恢复性 |
| 新任务 | UI 解除关联（不删除、不停止任务） | 不删除 | **任务仍在任务列表中**，可通过「加载任务」重新关联查看状态；仅在任务不处于 `queued/running` 时可用（校对进行中建议先「暂停」，预处理/合并进行中建议等待完成或直接删除任务） |
| 删除任务（未完成） | 停止并删除该任务 | `output/.jobs/{job_id}/`、`output/.inputs/{job_id}.txt`、`output/.state/jobs/{job_id}.json`，并从任务列表删除 | 任务不可再加载/继续；不会删除 `output/` 下已生成的最终输出文件（如果存在）（校对进行中需先「暂停」后才允许删除） |
| 删除任务记录（已完成） | 删除该任务的记录与中间态 | 同上（不删除 `output/` 成品） | 任务不可再加载；成品文件仍在 `output/` 目录 |
| 加载任务 | UI 关联到某个历史 `job_id` | 不删除 | 可恢复后续操作（继续预处理/继续校对/合并/下载），取决于任务当前状态 |

### 输入缓存（用于“重跑全部”）

为支持“重跑全部（新任务）无需重新上传文件”，服务端会在 `output/.inputs/{job_id}.txt` 缓存已解码的输入文本：

- 该缓存会在你点击「删除任务 / 删除任务记录」后一并删除
- 如果你仅合并完成（且勾选了“合并后清理中间产物（output/.jobs）”），`output/.jobs/{job_id}/` 可能会被自动清理，但输入缓存仍会保留，以便后续重跑全部

### 目录结构

```
output/.jobs/{job_id}/
├── README.txt
├── pre/{index:06d}.txt   # 发送给 LLM 的分片输入
├── out/{index:06d}.txt   # 分片最终输出（通过校验）
└── resp/{index:06d}.txt  # LLM 原始响应（覆盖式）
```

### UI 调试面板

位于「分析进度」标签页，提供：
- 统计栏：总计/完成/处理中/待处理/重试中/错误分片数
- 过滤器：全部/错误/重试中/处理中/待处理/完成
- 分片表格：状态、重试次数、输入输出字符数、错误信息

### 分片状态

| 状态 | 说明 |
|------|------|
| `pending` | 等待处理 |
| `processing` | 正在请求 |
| `retrying` | 等待重试 |
| `done` | 处理完成 |
| `error` | 处理失败 |
